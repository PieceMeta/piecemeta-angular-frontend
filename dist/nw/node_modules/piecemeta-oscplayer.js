var osc = require('osc'),
    udpPort;

module.exports.openPort = function (host, port) {
    udpPort = new osc.UDPPort({
        localAddress: host,
        localPort: port
    });
    udpPort.open();
};

module.exports.closePort = function () {
    udpPort.close();
};

module.exports.registerControls = function (callback) {
    if (!udpPort) {
        return;
    }
    udpPort.on("message", function (msg) {
        var address = msg.address.split('/');
        if (address.length < 3 || address[1] !== 'control') {
            return;
        }
        address.splice(0, 2);
        var args,
            command = address.shift();
        if (address.length >= 1) {
            args = address;
        }
        if (typeof callback === 'function') {
            callback(null, command, args);
        }
    });
};

module.exports.createMessage = function (address, args) {
    var msg = {
        address: address,
        args: args
    };
    return msg;
};

module.exports.createBundle = function (messages) {
    // TODO: make this better and more precise (use window.performance)
    var now = Date.now(), seconds = 2208988800,
        bundle = {
        timeTag: {
            raw: [
                seconds + Math.floor(now / 1000), // seconds since January 1, 1900.
                (now / 1000 - Math.floor(now / 1000)) * 1000 // fractions of a second
            ],
            native: Date.now() // Milliseconds since January 1, 1970
        },
        packets: messages
    };
    return bundle;
};

module.exports.send = function (host, port, payload, callback) {
    if (!udpPort) {
        if (typeof callback === 'function') {
            callback(new Error('UDP data port is not initialized'));
        }
    } else {
        udpPort.send(payload, host, port);
        if (typeof callback === 'function') {
            callback(null);
        }
    }
};