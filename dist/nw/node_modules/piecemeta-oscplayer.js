var osc = require('osc');
var udpPort;

module.exports.openPort = function (port) {
    udpPort = new osc.UDPPort({
        localAddress: "0.0.0.0",
        localPort: port
    });
    udpPort.open();
};

module.exports.createMessage = function (address, args) {
    var msg = {
        address: address,
        args: args
    };
    return msg;
};

module.exports.createBundle = function (messages) {
    // TODO: make this better and more precise (use window.performance)
    var now = Date.now(), seconds = 2208988800;
    var bundle = {
        timeTag: {
            raw: [
                seconds + Math.floor(now / 1000), // seconds since January 1, 1900.
                (now / 1000 - Math.floor(now / 1000)) * 1000 // fractions of a second
            ],
            native: Date.now() // Milliseconds since January 1, 1970
        },
        packets: messages
    };
    return bundle;
};

module.exports.send = function (host, port, payload, callback) {
    if (!udpPort) {
        if (typeof callback === 'function') {
            callback(new Error('UDP port is not open'));
        }
    } else {
        udpPort.send(payload, host, port);
        if (typeof callback === 'function') {
            callback(null);
        }
    }
};