/*! piecemeta-angular-frontend main node-webkit app - v0.9.2 - 2014-12-13 */

angular.module("piecemeta-web.directives.helpers",["piecemeta-web.services.api","piecemeta-web.services.auth"]).directive("checkLogin",["apiService","authService",function(a,b){"use strict";return{link:function(c){c.updateUser=function(){b.access_token&&a("users").actions.find("me",function(a,b){return a?(console.log("error fetching user",a),void(c.userSession=null)):void(c.userSession=b)})},c.updateUser()}}}]).directive("getAvatar",function(){"use strict";return{restrict:"A",transclude:!0,scope:{userObject:"=userObject"},link:function(a,b,c){a.$watch("userObject",function(){if(a.userObject&&a.userObject.email){var d=a.userObject.id;"robohash"===a.userObject.avatar&&b.attr("src","http://robohash.org/"+d+".jpg"),"gravatar"===a.userObject.avatar&&b.attr("src","http://www.gravatar.com/avatar/"+d+"?d=mm"+(c.width?"&s="+c.width:"")),"unicornify"===a.userObject.avatar&&b.attr("src","http://unicornify.appspot.com/avatar/"+d+(c.width?"?s="+c.width:""))}},!0)}}}),angular.module("piecemeta-web.services.api",[]).factory("apiService",["authService",function(a){"use strict";var b=function(b){var c=PMApi({host:PIECEMETA_API_HOST,contentType:"application/json",api_key:a.api_key,access_token:a.access_token});return{client:c,actions:{all:function(a,d){c.resource(b).action("get",null,a,d)},find:function(a,d,e){c.resource(b).action("get",{id:a},d,e)},create:function(a,d,e){c.resource(b).action("post",a,d,e)},update:function(a,d,e,f){d.id=a,c.resource(b).action("put",d,e,f)},remove:function(a,d,e){c.resource(b).action("delete",{id:a},d,e)}},getCredentials:function(b,d){c.setToken(b),c.getCredentials(function(c,e){return c?d(c):void("object"==typeof e?(a.setCredentials(e,b),d(null)):d(new Error("Failed to get credentials")))})},authenticate:function(b,d,e){c.getToken({email:b,password:d},function(b,d){return b?e(b):void("object"==typeof d?c.getCredentials(function(b,c){return b?e(b):void("object"==typeof c?(a.setCredentials(c,d),e(null)):e(new Error("Failed to get credentials")))}):e(new Error("Failed to get token")))})}}};return b}]),function(){"use strict";angular.module("piecemeta-web.services.auth",[]).factory("authService",["$http",function(){var a={api_key:null,access_token:null,getCredentials:function(){a.api_key="string"==typeof localStorage.api_key?JSON.parse(localStorage.api_key):null,a.access_token="string"==typeof localStorage.access_token?JSON.parse(localStorage.access_token):null},setCredentials:function(b,c){localStorage.api_key=JSON.stringify(b),localStorage.access_token=JSON.stringify(c),a.getCredentials()},clearCredentials:function(){localStorage.removeItem("api_key"),localStorage.removeItem("access_token"),a.getCredentials()}};return a.getCredentials(),a}])}(),angular.module("piecemeta-web.services.spatial-viewer",[]).factory("spatialViewer",[function(){"use strict";var a={scene:new THREE.Scene,renderer:new THREE.CanvasRenderer,hierarchy:new THREE.Object3D,camera:null,meshes:{},dataSequence:null,frameIndex:0,frameCount:0,init:function(b,c,d){var e=document.querySelector(c).offsetWidth,f=document.querySelector(c).offsetHeight;0===f&&(f=320),a.dataPackage=b,a.camera=new THREE.PerspectiveCamera(75,e/f,1,1e4),a.camera.position.z=1e3,a.renderer.setSize(e,f);for(var g in b.data_channels)if("object"==typeof b.data_channels[g]){var h=new THREE.BoxGeometry(10,10,10),i=new THREE.MeshBasicMaterial({color:16711680,wireframe:!0}),j=new THREE.Mesh(h,i);a.meshes[b.data_channels[g].id]=j;for(var k in b.data_channels[g].data_streams)if("object"==typeof b.data_channels[g].data_streams[k]){var l=b.data_channels[g].data_streams[k];l.data_frames.length>a.frameCount&&(a.frameCount=l.data_frames.length),"number"==typeof l.data_frames[a.frameIndex]&&(a.meshes[b.data_channels[g].id][l.group][l.title]=10*(l.value_offset+l.data_frames[a.frameIndex]))}}for(var m in b.data_channels)if("object"==typeof b.data_channels[m]){var n=b.data_channels[m];n.parent_data_channel_id?a.meshes[n.parent_data_channel_id].add(a.meshes[n.id]):a.hierarchy.add(a.meshes[n.id])}a.scene.add(a.hierarchy),document.querySelector(c).appendChild(a.renderer.domElement),a.animate(),"function"==typeof d&&d()},animate:function(){window.requestAnimationFrame(a.animate),a.renderer.render(a.scene,a.camera)}};return a}]),function(){"use strict";angular.module("piecemeta-frontend",["ui.bootstrap","ngRoute","cgBusy","btford.markdown","piecemeta-web.directives.helpers"]).config(["$routeProvider","$locationProvider","$logProvider",function(a,b,c){c.debugEnabled(!0)}]).run(["$rootScope","$q",function(a,b){a.$on("$routeChangeStart",function(){a.pageDefer=b.defer(),a.pagePromise=a.pageDefer.promise}),a.$on("$routeChangeSuccess",function(){a.pageDefer.resolve()}),a.$on("$routeChangeError",function(){a.pageDefer.reject()})}])}();