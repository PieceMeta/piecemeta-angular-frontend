/*! piecemeta-angular-frontend main web app - v0.9.2 - 2015-04-10 */

!function(){"use strict";angular.module("piecemeta-web.controllers.collections",["piecemeta-web.services.api"]).controller("Collections.Create",["$scope","apiService","$q","$location","$routeParams",function(a,b,c,d){a.dataCollection={title:null,description:null},a.formTitle="Create Collection",a.submit=function(){var e=c.defer();a.promiseString="Saving...",a.promise=e.promise,b("collections").actions.create(a.dataCollection,function(b,c){return b?(a.alerts=[{type:"danger",msg:"Failed to save Collection."}],void e.reject(b)):(a.alerts=[{type:"success",msg:"Successfully created Collection."}],e.resolve(),void d.path("/collections/"+c.uuid+"/edit"))})}}]).controller("Collections.Edit",["$scope","$routeParams","$q","apiService",function(a,b,c,d){var e=c.defer();a.promiseString="Loading Collection...",a.promise=e.promise,a.formTitle="Edit Collection",d("collections").actions.find(b.uuid,function(f,g){return f?(a.alerts=[{type:"danger",msg:"Failed to load Collection."}],e.reject(f),console.log("error getting collection",f)):(a.dataCollection=g,e.resolve(),void(a.submit=function(){var e=c.defer();a.promiseString="Saving...",a.promise=e.promise,d("collections").actions.update(b.uuid,a.dataCollection,function(b){return b?(console.log(b),a.alerts=[{type:"danger",msg:"Failed to update Collection."}],void e.reject(b)):(a.alerts=[{type:"success",msg:"Successfully updated Collection."}],void e.resolve())})}))})}])}(),function(){"use strict";angular.module("piecemeta-web.controllers.data-channels",["angularFileUpload","piecemeta-web.services.api"]).controller("DataChannels.Create",["$scope","apiService","$q","$location","$routeParams",function(a,b,c,d,e){var f=c.defer();a.data={dataChannel:{package_uuid:e.package_uuid}},a.formTitle="Create channel",a.promiseString="Loading...",a.promise=f.promise,async.waterfall([function(a){b("packages").actions.find(e.package_uuid,a)},function(b,c){return b?(a.data.dataPackage=b,void c(null)):void c(new Error("No package found."))}],function(g){return g?(a.alerts=[{type:"danger",msg:"Failed to load package."}],void f.reject(g)):(f.resolve(),void(a.submit=function(){var f=c.defer();a.promiseString="Saving...",a.promise=f.promise,b("channels").actions.create(a.data.dataChannel,function(b){return b?(a.alerts=[{type:"danger",msg:"Failed to save channel."}],void f.reject(b)):(a.alerts=[{type:"danger",msg:"Successfully saved channel."}],f.resolve(),void d.path("/packages/edit/"+e.package_uuid))})}))})}]).controller("DataChannels.Edit",["$scope","$routeParams","$q","apiService",function(a,b,c,d){var e=c.defer();a.data={},a.promiseString="Loading channel...",a.promise=e.promise,a.formTitle="Edit channel",async.waterfall([function(a){d("channels").actions.find(b.uuid,a)},function(b,c){return b?(a.data.dataChannel=b,a.formTitle='Edit "'+b.title+'"',void c(null)):void c(new Error("No channel found."))},function(b){d("packages").actions.find(a.data.dataChannel.package_uuid,b)},function(b,c){return b?(a.data.dataPackage=b,void c(null)):void c(new Error("No package found."))},function(a){d("channels/"+b.uuid+"/streams").actions.all(a)},function(b,c){b.length>0&&(a.data.dataStreams=b.sort(function(a,b){return a.group<b.group?-1:a.group>b.group?1:0})),c(null)}],function(f){return f?(a.alerts=[{type:"danger",msg:"Failed to load channel."}],void e.reject(f)):(e.resolve(),a.$apply(),a.deleteStream=function(b,c){c.preventDefault(),window.confirm("Do you really want to delete this stream?")&&(a.promiseString="Deleting data stream...",a.promise=e.promise,a.data.dataStreams.splice(a.data.dataStreams.indexOf(b),1),d("streams").actions.remove(b.uuid,function(b){return b?(a.alerts=[{type:"danger",msg:"Failed to delete stream."}],e.reject(b),console.log("error deleting stream",b)):(a.alerts=[{type:"success",msg:"Successfully saved stream."}],e.resolve(),void a.$apply())}))},void(a.submit=function(){var e=c.defer();a.promiseString="Saving...",a.promise=e.promise,d("channels").actions.update(b.uuid,a.data.dataChannel,function(b){return b?(console.log(b),a.alerts=[{type:"danger",msg:"Failed to update channel."}],void e.reject(b)):(e.resolve(),void(a.alerts=[{type:"success",msg:"Successfully updated channel."}]))})}))})}])}(),function(){"use strict";angular.module("piecemeta-web.controllers.data-packages",["angularFileUpload","piecemeta-web.services.api","chartjs"]).controller("DataPackages.ImportBVH",["$scope","$q","authService","apiService",function(a,b,c,d){a.file=null,a.onFileSelect=function(c){var e=b.defer();a.promiseString="Importing data...",a.promise=e.promise,a.file=c[0],a.dataPackage=null,a.dataChannels=[];var f=new FileReader;f.onload=function(b){async.waterfall([function(a){a(null,BVH.parse(b.target.result))},function(b,c){a.motion=b,c(null)},function(a){var b={title:c[0].name};d("packages").actions.create(b,function(b,c){a(b,c)})},function(b,c){a.dataPackage=b,c(null)},function(b){async.eachSeries(a.motion.nodeList,function(b,c){var e={title:b.id,package_uuid:a.dataPackage.uuid};d("channels").create(e,function(e,f){if(e)return c(e);a.dataChannels.push(f);var g=[{title:"x",group:"position",value_offset:b.offsetX},{title:"y",group:"position",value_offset:b.offsetY},{title:"z",group:"position",value_offset:b.offsetZ},{title:"z",group:"rotation"},{title:"y",group:"rotation"},{title:"x",group:"rotation"}];for(var h in g)"object"==typeof g[h]&&(g[h].frames=[],g[h].fps=parseFloat((1/a.motion.frameTime).toFixed(2)));for(var i in b.frames)if("object"==typeof b.frames[i]){var j=b.frames[i];for(var k in j)"number"==typeof j[k]&&g[k].frames.push(j[k])}async.eachSeries(g,function(a,b){a.channel_uuid=f.uuid,d("streams").actions.create(a,function(a){b(a)})},function(a){c(a)})})},function(a){b(a)})},function(b){async.eachSeries(a.dataChannels,function(b,c){for(var e=0,f=a.motion.nodeList;f[e].id!==b.title&&e<f.length;)e+=1;if(f[e].parent){for(var g=0;a.dataChannels[g].title!==f[e].parent.id&&g<a.dataChannels.length;)g+=1;b.parent_channel_uuid=a.dataChannels[g].uuid,d("channels").actions.update(b.uuid,b,function(a){c(a)})}else c(null)},function(a){b(a)})}],function(a,b){return a?(console.log("error processing bvh file",a),void e.reject(a)):(console.log("successfully processed bvh file",b),void e.resolve())})},f.readAsText(c[0])}}]).controller("DataPackages.ImportOSC",["$scope","$q","authService","apiService","$routeParams",function(a,b,c,d,e){a.file=null,a.onFileSelect=function(c){var f=b.defer();a.promiseString="Importing data...",a.promise=f.promise,a.file=c[0],a.dataPackage=null,a.dataChannels=[];var g=new FileReader;g.onload=function(b){console.log("onload"),async.waterfall([function(a){var c;try{c=JSON.parse(b.target.result),a(null,c)}catch(d){a(new Error("error parsing json: "+d.toString()),null)}},function(a,b){if(e.garbage){var c=0,d={};for(var f in a)"object"==typeof a[f]&&a[f].length>0&&a[f].length>c&&(c=a[f].length);console.log("max frame is",c);for(var f in a)if("object"==typeof a[f]&&a[f].length>0&&(d[f]=[],a[f].length<c)){var g=c-a[f].length,h=Math.ceil(c/g),i=0;console.log("extend",a[f].length,g,h);for(var j=0;j<a[f].length;j+=1)a[f][j]&&(d[f].push(a[f][j]),g>i&&(d[f].push(a[f][j]),i+=1));for(;d[f].length<c;)d[f].push(a[f][a[f].length-1])}b(null,d)}else{var k=1e3/60,l={};for(var f in a)if("object"==typeof a[f]&&a[f].length>0){var m=1e3*a[f][0].m+a[f][0].s;l[f]=[],console.log("frames",a[f].length);for(var n in a[f]){for(var o=1e3*a[f][n].m+a[f][n].s,p=Math.round((o-m)/k),q=0;p>q;q+=1){var r=q*k,s=o+r;l[f].push({a:a[f][n].a,m:Math.floor(s/1e3),s:1e3*(s/1e3-Math.floor(s/1e3))})}m=o}}b(null,l)}},function(a,b){if(e.garbage){for(var c in a)"object"==typeof a[c]&&a[c].length>0&&console.log(c,a[c].length);b(null,a)}else{var d={},f=1e3/60;for(var c in a)if("object"==typeof a[c]&&a[c].length>0){var g=0,h=1e3*a[c][0].m+a[c][0].s;d[c]=[],console.log("frames",a[c].length);for(var i in a[c]){var j=1e3*a[c][i].m+a[c][i].s,k=Math.round((j-h)/f);1!==k?(g+=1,console.log("dropped faulty frame with diff != 1at",k,i)):d[c].push(a[c][i]),h=j}console.log("total faults",g)}b(null,d)}},function(a,b){if(e.garbage)b(null,a);else{var c=1e3/60;for(var d in a)if("object"==typeof a[d]&&a[d].length>0){var f=0,g=1e3*a[d][0].m+a[d][0].s;console.log("cleaned frames for index",d,a[d].length);for(var h in a[d]){var i=1e3*a[d][h].m+a[d][h].s,j=Math.round((i-g)/c);1!==j&&(f+=1),g=i}console.log("total faults",f)}b(null,a)}},function(a,b){var e={title:c[0].name};d("packages").actions.create(e,function(c,d){b(c,d,a)})},function(b,c,d){a.dataPackage=b,console.log(a.dataPackage),d(null,c)},function(b,c){for(var d in b)if("object"==typeof b[d]&&b[d].length>0){for(var e={title:d.substr(1,d.length-1),id:null,package_uuid:a.dataPackage.uuid,streams:[]},f=b[d][0].a.length,g=0;f>g;g+=1)e.streams.push({id:null,fps:60,channel_id:null,title:"p"+g.toString(),group:f>1?"grouped":null,frames:[]});for(var h in b[d])for(var i=0;f>i;i+=1)e.streams[i].frames.push(b[d][h].a[i]);a.dataChannels.push(e)}c(null)},function(b){async.eachSeries(a.dataChannels,function(b,c){b.package_uuid=a.dataPackage.uuid,d("channels").actions.create(b,function(e,f){return e?c(e):(a.dataChannels[a.dataChannels.indexOf(b)].uuid=f.uuid,void async.eachSeries(a.dataChannels[a.dataChannels.indexOf(b)].streams,function(a,b){a.channel_uuid=f.uuid,d("streams").actions.create(a,function(a){b(a)})},function(a){c(a)}))})},function(a){b(a)})}],function(a,b){return a?(console.log("error processing json file",a),void f.reject(a)):(console.log("successfully processed json file",b),void f.resolve())})},g.readAsText(c[0])}}]).controller("DataPackages.Show",["$scope","$q","$routeParams","apiService",function(a,b,c,d){a.data={dataChannels:[],streamGroups:[],dataPackage:null,currentGroup:null,channelIndex:0,chartSetup:{graphOptions:{showTooltips:!0,scaleShowLabels:!0,animation:!1,responsive:!0,pointDot:!1,bezierCurve:!1,scaleShowGridLines:!1,datasetFill:!1,legend:!0}},exports:{json:PIECEMETA_API_HOST+"/exports/"+c.uuid+".json",msgpack:PIECEMETA_API_HOST+"/exports/"+c.uuid+".msgpack",xml:PIECEMETA_API_HOST+"/exports/"+c.uuid+".xml"}},a.updateTimeout=null;var e=b.defer();a.promiseString="Loading data...",a.promise=e.promise,a.onURLClick=function(a){a.target.select()},a.updateChart=function(){var b={},c=0,d=null,e=["#ff0000","#732e00","#b2a159","#435946","#b6def2","#8660bf","#ff0088","#e50000","#331c0d","#d6e600","#40ffa6","#0066bf","#a38fbf","#4c0029","#d90000","#ffb380","#494d13","#269973","#80b3ff","#442d59","#99003d","#590000","#a67453","#818c69","#b6f2de","#434c59","#33004d","#bf6086","#d96c6c","#ffd9bf","#81f200","#005359","#334166","#a300cc","#d9003a","#332626","#cc8800","#448000","#36ced9","#263699","#fbbfff","#e6acbb","#7f2d20","#7f5500","#d6f2b6","#698a8c","#3d3df2","#cc33ad","#733941","#8c7369","#665533","#8fcc66","#002b40","#140099","#664d61","#ff6600","#ffcc00","#17330d","#308fbf","#120d33","#802060"];if(a.data.streamGroups=[],d=a.data.currentChannel){var f=Math.floor(8*Math.random());for(var g in d.streams)if(d.streams[g].frames.length>0){var h=[];if(d.streams[g].frames.length>1e3)for(var i=Math.floor(d.streams[g].frames.length/500),j=0;j<d.streams[g].frames.length;j+=i)h.push(d.streams[g].frames[j]);else h=d.streams[g].frames;if("object"==typeof d.streams[g]){for(var k=(d.streams[g].group?d.streams[g].group+"/":"")+d.streams[g].title,l=[],m=0;3>m;m+=1)l.push(Math.round(100*Math.random())+100);var n=e.splice(f,1),o={label:k,strokeColor:n,highlightStroke:n,pointColor:n,data:h};o.data.length>c&&(c=o.data.length),(!a.data.currentGroup||a.data.currentGroup&&a.data.currentGroup===d.streams[g].group)&&(b[k]=o),a.data.streamGroups.indexOf(d.streams[g].group)<0&&a.data.streamGroups.push(d.streams[g].group)}}else console.log("empty stream");var p=[],q=[];for(var r in b)"object"==typeof b[r]&&p.push(b[r]);for(var s=1;c>=s;s+=1)q.push("");a.data.streamGroups=a.data.streamGroups.sort(),a.data.currentGroup||(a.data.currentGroup=a.data.streamGroups[0]);var t={labels:q,datasets:p};a.data.chartSetup.graphDataSet=t}},async.waterfall([function(a){d("packages").actions.find(c.uuid,a)},function(a,b){d("users").actions.find(a.user_uuid,function(c,d){b(c,a,d)})},function(b,c,d){a.data.dataPackage=b,a.data.packageAuthor=c,a.data.dataURL=PIECEMETA_API_HOST+"/packages/"+b.uuid,d(null)},function(b){d("packages/"+a.data.dataPackage.uuid+"/channels").actions.all(b)},function(b,c){a.data.dataPackage.channels=b.sort(function(a,b){return a.title<b.title?-1:a.title>b.title?1:0}),c(null)},function(b){async.eachSeries(a.data.dataPackage.channels,function(b,c){d("channels/"+b.uuid+"/streams").actions.all(function(d,e){return d?c(d):(a.data.dataPackage.channels[a.data.dataPackage.channels.indexOf(b)].streams=e,void c())})},function(a){b(a)})},function(b){for(var c in a.data.dataPackage.channels)"object"==typeof a.data.dataPackage.channels[c]&&a.data.dataPackage.channels[c].streams.length>0&&a.data.dataChannels.push(a.data.dataPackage.channels[c]);b(null)},function(b){a.data.dataChannels.length>0&&(a.data.currentChannel=a.data.dataChannels[0]),b(null)},function(b){a.updateChart(),b(null)},function(b){a.$watch("data.currentChannel",function(){a.data.currentGroup=null,a.updateChart()},!0),a.$watch("data.currentGroup",function(){a.updateChart()},!0),b(null)}],function(b){return b?(e.reject(b),console.log("error getting data",c,b),void(a.$parent.status="ready")):(a.$apply(),e.resolve(),void(a.$parent.status="ready"))})}]).controller("DataPackages.List",["$scope","apiService",function(a,b){a.data={},b("packages").actions.all(function(b,c){return b?console.log("error getting packages",b):(a.data.data_packages=c.sort(function(a,b){return a.title<b.title?-1:a.title>b.title?1:0}),void a.$apply())})}]).controller("DataPackages.Create",["$scope","apiService","$q","$location",function(a,b,c,d){a.dataPackage={title:null,description:null,contributor_uuid:null},a.formTitle="Create package",a.submit=function(){var e=c.defer();a.promiseString="Saving...",a.promise=e.promise,b("packages").actions.create(a.dataPackage,function(b,c){return b?(a.alerts=[{type:"danger",msg:"Failed to save Package."}],void e.reject(b)):(a.alerts=[{type:"success",msg:"Successfully saved Package."}],e.resolve(),void d.path("/packages/"+c.uuid+"/edit"))})}}]).controller("DataPackages.Edit",["$scope","$routeParams","$q","apiService",function(a,b,c,d){var e=c.defer();a.promiseString="Loading Package...",a.promise=e.promise,a.formTitle="Edit package",a.deleteChannel=function(b,c){c.preventDefault(),window.confirm("Do you really want to delete this channel?")&&(a.promiseString="Deleting Channel...",a.promise=e.promise,a.dataChannels.splice(a.dataChannels.indexOf(b),1),d("channels").actions.remove(b.uuid,function(b){return b?(a.alerts=[{type:"danger",msg:"Failed to delete Channel."}],e.reject(b),console.log("error deleting channel",b)):void e.resolve()}))},a.submit=function(){var e=c.defer();a.promiseString="Saving...",a.promise=e.promise,d("packages").actions.update(b.uuid,a.dataPackage,function(b){return b?(console.log(b),a.alerts=[{type:"danger",msg:"Failed to update Package."}],void e.reject(b)):(e.resolve(),void(a.alerts=[{type:"success",msg:"Successfully updated Package."}]))})},d("packages").actions.find(b.uuid,function(b,c){return b?(a.alerts=[{type:"danger",msg:"Failed to load Package."}],e.reject(b),console.log("error getting package",b)):(a.dataPackage=c,a.formTitle='Edit "'+c.title+'"',void d("packages/"+c.uuid+"/channels").actions.all(function(b,c){return b?(a.alerts=[{type:"danger",msg:"Failed to load Channels."}],e.reject(b),console.log("error getting channels",b)):(c.length>0&&(a.dataChannels=c.sort(function(a,b){return a.title<b.title?-1:a.title>b.title?1:0})),e.resolve(),void a.$apply())}))})}])}(),function(){"use strict";angular.module("piecemeta-web.controllers.data-streams",["angularFileUpload","piecemeta-web.services.api"]).controller("DataStreams.Create",["$scope","apiService","$q","$location","$routeParams",function(a,b,c,d,e){a.data={dataStream:{channel_uuid:e.uuid}};var f=c.defer();a.promiseString="Loading...",a.promise=f.promise,a.formTitle="Create stream",async.waterfall([function(a){b("channels").actions.find(e.uuid,a)},function(b,c){return b?(a.data.dataChannel=b,a.formTitle='Edit "'+b.title+'"',void c(null)):void c(new Error("No channel found."))},function(c){b("packages").actions.find(a.data.dataChannel.package_uuid,c)},function(b,c){return b?(a.data.dataPackage=b,void c(null)):void c(new Error("No package found."))}],function(e){return e?(a.alerts=[{type:"danger",msg:"Failed to load channel."}],void f.reject(e)):void(a.submit=function(){var e=c.defer();a.promiseString="Saving...",a.promise=e.promise,b("streams").actions.create(a.dataStream,function(b,c){return b?(a.alerts=[{type:"danger",msg:"Failed to save stream."}],void e.reject(b)):(a.alerts=[{type:"success",msg:"Successfully saved stream."}],e.resolve(),void d.path("/streams/"+c.uuid+"/edit"))})})})}]).controller("DataStreams.Edit",["$scope","$routeParams","$q","apiService",function(a,b,c,d){var e=c.defer();a.data={},a.promiseString="Loading stream...",a.promise=e.promise,a.formTitle="Edit stream",async.waterfall([function(a){d("streams").actions.find(b.uuid,a)},function(b,c){return b?(a.data.dataStream=b,a.formTitle='Edit "'+b.title+'"',void c(null)):void c(new Error("No stream found."))},function(b){d("channels").actions.find(a.data.dataStream.channel_uuid,b)},function(b,c){return b?(a.data.dataChannel=b,void c(null)):void c(new Error("No channel found."))},function(b){d("packages").actions.find(a.data.dataChannel.package_uuid,b)},function(b,c){return b?(a.data.dataPackage=b,void c(null)):void c(new Error("No package found."))}],function(f){return f?(a.alerts=[{type:"danger",msg:"Failed to load stream."}],e.reject(f),console.log("error getting stream",f)):(e.resolve(),a.submit=function(){var e=c.defer();a.promiseString="Saving...",a.promise=e.promise,d("streams").actions.update(b.uuid,a.data.dataStream,function(b){return b?(console.log(b),a.alerts=[{type:"danger",msg:"Failed to update data stream."}],void e.reject(b)):(a.alerts=[{type:"success",msg:"Successfully updated stream."}],void e.resolve())})},void(a.onFileSelect=function(b){var c=new FileReader;c.onload=function(b){var c;try{c=JSON.parse(b.target.result)}catch(d){return console.log("error parsing json",d),void(a.alerts=[{type:"danger",msg:"Error parsing JSON"}])}"object"==typeof c&&c.length>0&&"number"==typeof c[0]?a.dataStream.data_frames=c:a.alerts=[{type:"danger",msg:"JSON is not in the required format"}]},c.readAsText(b[0])}))})}]).controller("DataStreams.ImportFile",["$scope","$q","apiService","$routeParams","$location",function(a,b,c,d,e){var f="",g=b.defer();a.data={dataPackage:null,selectedChannel:{},startFrame:1,regexString:"",regexPresets:[{title:"3 Numbers separated by space",data:"([-+]?[0-9]*\\.?[0-9]+) ([-+]?[0-9]*\\.?[0-9]+) ([-+]?[0-9]*\\.?[0-9]+)"},{title:"3 Numbers separated by semicolon",data:"([-+]?[0-9]*\\.?[0-9]+);([-+]?[0-9]*\\.?[0-9]+);([-+]?[0-9]*\\.?[0-9]+)"},{title:"2 Numbers separated by comma and enclosed in quotes",data:'"([-+]?[0-9]*\\.?[0-9]+)","([-+]?[0-9]*\\.?[0-9]+)"'}],channelTitle:"",resultLines:[],isComplete:!1},a.fileLines=[],a.frameCount=0,a.valLength=0,a.valLabel=[],a.promiseString="Loading...",a.promise=g.promise,async.waterfall([function(a){c("packages").actions.find(d.uuid,a)},function(b,c){b?(a.data.dataPackage=b,c(null)):c(new Error("package not found"))},function(a){c("packages/"+d.uuid+"/channels").actions.all(a)},function(b,c){b?(a.data.dataChannels=b,c(null)):c(new Error("no channels found"))}],function(a){return a?(console.log("error getting package",a),void g.reject(a)):void g.resolve()});var h=function(){if(a.regex){a.data.resultLines=[],a.valLength=0,a.valLabel=[];for(var b in a.fileLines){for(var c=null,d=[];null!==(c=a.regex.exec(a.fileLines[b]));)d=c;d.shift(),a.valLength<d.length&&(a.valLength=d.length),a.data.resultLines.push(d)}for(var e=0;e<a.valLength;e+=1)a.valLabel.push("")}};a.parseLines=function(){var b=f.split("\n");a.frameCount=b.length,a.fileLines=b.slice(Math.abs(parseInt(a.data.startFrame)),10),h()},a.updateRegex=function(b){b&&""!==b&&(a.regex=new RegExp(b,"gm"),h())},a.onFileSelect=function(c){var d=b.defer();a.promiseString="Reading file...",a.promise=d.promise;var e=new FileReader;e.onload=function(b){f=b.target.result,a.updateRegex(a.data.regexString),a.parseLines(),d.resolve()},e.readAsText(c[0])},a.submit=function(){var g=b.defer();if(a.promiseString="Adding channel...",a.promise=g.promise,a.$broadcast("show-errors-check-validity"),a.channelImportForm.$invalid)return a.alerts=[{type:"danger",msg:"You have to at least enter a title, frame rate and value titles."}],void g.reject();var h=[],i=f.split("\n");async.waterfall([function(b){for(var c=0;c<a.valLength;c+=1){var d={channel_uuid:a.data.selectedChannel.uuid,title:a.valLabel[c],fps:a.data.fps,group:a.data.valueGroup,frames:[]};h.push(d)}b(null)},function(b){for(var c in i){for(var d=null,e=[];null!==(d=a.regex.exec(i[c]));)e=d;e.shift();for(var f in e)"object"==typeof h[f]&&h[f].frames.push(e[f])}b(null)},function(b){if(a.data.selectedChannel.uuid)b(null,null);else{var e={package_uuid:d.uuid,title:a.data.selectedChannel.title?a.data.selectedChannel.title:a.data.channelTitle};c("channels").actions.create(e,b)}},function(b,c){c(null,a.data.selectedChannel.uuid||b.uuid)},function(a,b){async.eachSeries(h,function(b,d){b.channel_uuid=a,c("streams").actions.create(b,d)},function(a){b(a)})}],function(b){return b?(a.alerts=[{type:"danger",msg:"Failed to add streams"}],console.log("failed to create streams",b),void g.reject()):(a.alerts=[{type:"danger",msg:"Successfully added streams"}],e.path("/packages/"+d.uuid+"/edit"),void g.resolve())})}}]).controller("DataStreams.ImportTrac",["$scope","$q","apiService","$routeParams","$location",function(a,b,c,d,e){var f="",g=b.defer();a.data={dataPackage:null,dataChannels:null,dataStreams:[],selectedChannel:{},channelTitle:"",startFrame:1,fps:null,resultLines:[],isComplete:!1},a.fileLines=[],a.frameCount=0,a.valLength=0,a.valLabel=[],a.promiseString="Loading...",a.promise=g.promise,async.waterfall([function(a){c("packages").actions.find(d.uuid,a)},function(b,c){b?(a.data.dataPackage=b,c(null)):c(new Error("package not found"))},function(a){c("packages/"+d.uuid+"/channels").actions.all(a)},function(b,c){b?(a.data.dataChannels=b,c(null)):c(new Error("no channels found"))}],function(a){return a?(console.log("error getting package",a),void g.reject(a)):void g.resolve()}),a.parseLines=function(b){var c=Papa.parse(f).data,d=c.splice(0,5),e=d[3];e.splice(0,1);var g=d[4];for(g.splice(0,2);null===g[g.length-1]||""===g[g.length-1];)g.pop();var h=g.length+1;e=e.filter(function(a){return""!=a});var i=0;async.waterfall([function(b){a.data.fps=parseFloat(d[2][0]),a.frameCount=c.length,a.fileLines=c.slice(Math.abs(parseInt(a.data.startFrame)),10),b()},function(b){var c={channel_uuid:a.data.selectedChannel.uuid,title:e.shift(),frames:[],fps:a.data.fps};a.data.dataStreams.push(c),b()},function(b){async.eachSeries(e,function(b,c){var d=g.splice(0,3);async.each(d,function(c,d){var e={channel_uuid:a.data.selectedChannel.uuid,title:c.replace(/[0-9]/g,""),group:b,frames:[],fps:a.data.fps};a.data.dataStreams.push(e),d()},function(a){c(a)})},b)},function(b){for(var d in c){var e=c[d];e.splice(0,1),h!==e.length&&(i+=1);for(var f=0;h>f;f+=1)a.data.dataStreams[f].frames.push("undefined"==typeof e[f]?null:parseFloat(e[f]))}b()}],function(a){b(a,i)})},a.onFileSelect=function(c){var d=b.defer();a.promiseString="Reading file...",a.promise=d.promise;var e=new FileReader;e.onload=function(b){f=b.target.result,a.parseLines(function(b,c){c>0&&(a.alerts=[{type:"warning",msg:"The data contains "+c+" line(s) containing a different number of values than labels."}]),d.resolve(),a.$apply()})},e.readAsText(c[0])},a.submit=function(){var f=b.defer();return a.promiseString="Adding channel...",a.promise=f.promise,a.$broadcast("show-errors-check-validity"),a.tracImportForm.$invalid?(a.alerts=[{type:"danger",msg:"You have to at least enter a title, frame rate and value titles."}],void f.reject()):void async.waterfall([function(b){if(a.data.selectedChannel.uuid)b(null,null);else{var e={package_uuid:d.uuid,title:a.data.selectedChannel.title?a.data.selectedChannel.title:a.data.channelTitle};c("channels").actions.create(e,b)}},function(b,c){c(null,a.data.selectedChannel.uuid||b.uuid)},function(b,d){async.eachSeries(a.data.dataStreams,function(a,d){a.channel_uuid=b,c("streams").actions.create(a,d)},function(a){d(a)})}],function(b){return b?(a.alerts=[{type:"danger",msg:"Failed to add streams"}],console.log("failed to create streams",b),void f.reject()):(a.alerts=[{type:"danger",msg:"Successfully added streams"}],e.path("/packages/"+d.uuid+"/edit"),void f.resolve())})}}])}(),angular.module("piecemeta-web.directives.helpers",["piecemeta-web.services.api","piecemeta-web.services.auth"]).directive("checkLogin",["apiService","authService",function(a,b){"use strict";return{link:function(c){c.updateUser=function(){b.access_token&&a("users").actions.find("me",function(a,b){return a?(console.log("error fetching user",a),void(c.userSession=null)):(c.userSession=b,void c.$apply())})},c.updateUser()}}}]),angular.module("piecemeta-web.services.api",[]).factory("apiService",["authService",function(a){"use strict";return function(b,c){var d=PMApi({host:c?c:PIECEMETA_API_HOST,contentType:"application/json",api_key:a.api_key,access_token:a.access_token});return{client:d,actions:{all:function(a,c){d.resource(b).action("get",null,a,c)},find:function(a,c,e){d.resource(b).action("get",a,c,e)},create:function(a,c,e){d.resource(b).action("post",a,c,e)},update:function(a,c,e,f){c.uuid=a,d.resource(b).action("put",c,e,f)},remove:function(a,c,e){d.resource(b).action("delete",a,c,e)}},getCredentials:function(b,c){d.setToken(b),d.getCredentials(function(d,e){return d?c(d):void("object"==typeof e?(a.setCredentials(e,b),c(null)):c(new Error("Failed to get credentials")))})},authenticate:function(b,c,e){d.getToken({email:b,password:c},function(b,c){return b?e(b):void("object"==typeof c?d.getCredentials(function(b,d){return b?e(b):void("object"==typeof d?(a.setCredentials(d,c),e(null)):e(new Error("Failed to get credentials")))}):e(new Error("Failed to get token")))})}}}}]),function(){"use strict";angular.module("piecemeta-web.services.auth",[]).factory("authService",["$http",function(){var a={api_key:null,access_token:null,getCredentials:function(){a.api_key="string"==typeof localStorage.api_key?JSON.parse(localStorage.api_key):null,a.access_token="string"==typeof localStorage.access_token?JSON.parse(localStorage.access_token):null},setCredentials:function(b,c){localStorage.api_key=JSON.stringify(b),localStorage.access_token=JSON.stringify(c),a.getCredentials()},clearCredentials:function(){localStorage.removeItem("api_key"),localStorage.removeItem("access_token"),a.getCredentials()}};return a.getCredentials(),a}])}(),angular.module("piecemeta-web.services.spatial-viewer",[]).factory("spatialViewer",[function(){"use strict";var a={scene:new THREE.Scene,renderer:new THREE.CanvasRenderer,hierarchy:new THREE.Object3D,camera:null,meshes:{},dataSequence:null,frameIndex:0,frameCount:0,init:function(b,c,d){var e=document.querySelector(c).offsetWidth,f=document.querySelector(c).offsetHeight;0===f&&(f=320),a.dataPackage=b,a.camera=new THREE.PerspectiveCamera(75,e/f,1,1e4),a.camera.position.z=1e3,a.renderer.setSize(e,f);for(var g in b.data_channels)if("object"==typeof b.data_channels[g]){var h=new THREE.BoxGeometry(10,10,10),i=new THREE.MeshBasicMaterial({color:16711680,wireframe:!0}),j=new THREE.Mesh(h,i);a.meshes[b.data_channels[g].id]=j;for(var k in b.data_channels[g].data_streams)if("object"==typeof b.data_channels[g].data_streams[k]){var l=b.data_channels[g].data_streams[k];l.data_frames.length>a.frameCount&&(a.frameCount=l.data_frames.length),"number"==typeof l.data_frames[a.frameIndex]&&(a.meshes[b.data_channels[g].id][l.group][l.title]=10*(l.value_offset+l.data_frames[a.frameIndex]))}}for(var m in b.data_channels)if("object"==typeof b.data_channels[m]){var n=b.data_channels[m];n.parent_data_channel_id?a.meshes[n.parent_data_channel_id].add(a.meshes[n.id]):a.hierarchy.add(a.meshes[n.id])}a.scene.add(a.hierarchy),document.querySelector(c).appendChild(a.renderer.domElement),a.animate(),"function"==typeof d&&d()},animate:function(){window.requestAnimationFrame(a.animate),a.renderer.render(a.scene,a.camera)}};return a}]),function(){"use strict";angular.module("piecemeta-frontend",["ui.bootstrap","ngRoute","cgBusy","btford.markdown","piecemeta-web.controllers.site","piecemeta-web.controllers.users","piecemeta-web.controllers.collections","piecemeta-web.controllers.data-packages","piecemeta-web.controllers.data-channels","piecemeta-web.controllers.data-streams","piecemeta-web.controllers.trackers","piecemeta-web.directives.helpers"]).config(["$routeProvider","$locationProvider","$logProvider",function(a,b,c){c.debugEnabled(!0),b.html5Mode(!0).hashPrefix("!");var d="partials/";a.when("/",{templateUrl:d+"welcome.html",controller:"Site.Welcome"}),a.when("/about",{templateUrl:d+"about.html",controller:"Site.About"}),a.when("/software",{templateUrl:d+"software.html",controller:"Site.Software"}),a.when("/signup",{templateUrl:d+"signup.html",controller:"Users.Create"}),a.when("/me/account",{templateUrl:d+"account.html",controller:"Users.Edit"}),a.when("/confirm/:single_access_token",{templateUrl:d+"confirm",controller:"Users.Confirm"}),a.when("/login",{templateUrl:d+"login.html",controller:"Users.Login"}),a.when("/logout",{templateUrl:d+"logout.html",controller:"Users.Logout"}),a.when("/packages/browse",{templateUrl:d+"packages_browse.html",controller:"DataPackages.List"}),a.when("/packages/:uuid/channels/import/csv",{templateUrl:d+"streams_import.html",controller:"DataStreams.ImportFile"}),a.when("/packages/:uuid/channels/import/trac",{templateUrl:d+"streams_import_trac.html",controller:"DataStreams.ImportTrac"}),a.when("/packages/upload",{templateUrl:d+"packages_upload.html",controller:"DataPackages.ImportBVH"}),a.when("/packages/uploadosc",{templateUrl:d+"packages_upload_osc.html",controller:"DataPackages.ImportOSC"}),a.when("/packages/create",{templateUrl:d+"packages_edit.html",controller:"DataPackages.Create"}),a.when("/packages/:uuid/edit",{templateUrl:d+"packages_edit.html",controller:"DataPackages.Edit"}),a.when("/packages/:uuid/show",{templateUrl:d+"packages_show.html",controller:"DataPackages.Show"}),a.when("/collections/create",{templateUrl:d+"collections_edit.html",controller:"Collections.Create"}),a.when("/collections/:uuid/edit",{templateUrl:d+"collections_edit.html",controller:"Collections.Edit"}),a.when("/channels/:uuid/streams/create",{templateUrl:d+"streams_edit.html",controller:"DataStreams.Create"}),a.when("/streams/:uuid/edit",{templateUrl:d+"streams_edit.html",controller:"DataStreams.Edit"}),a.when("/packages/:package_uuid/channels/create",{templateUrl:d+"channels_edit.html",controller:"DataChannels.Create"}),a.when("/channels/:uuid/edit",{templateUrl:d+"channels_edit.html",controller:"DataChannels.Edit"}),a.when("/trackers",{templateUrl:d+"trackers_list.html",controller:"Trackers.List"}),a.when("/trackers/create",{templateUrl:d+"trackers_edit.html",controller:"Trackers.Create"}),a.when("/trackers/:uuid/edit",{templateUrl:d+"trackers_edit.html",controller:"Trackers.Edit"}),a.otherwise({redirectTo:"/"})}]).run(["$rootScope","$q",function(a,b){Modernizr.localstorage&&Modernizr.canvas&&Modernizr.hashchange&&Modernizr.fontface||window.alert("Your browser is too old or not compatible with this website. It may still work, but most likely won't."),a.$on("$routeChangeStart",function(){a.pageDefer=b.defer(),a.pagePromise=a.pageDefer.promise}),a.$on("$routeChangeSuccess",function(){a.pageDefer.resolve()}),a.$on("$routeChangeError",function(){a.pageDefer.reject()})}])}(),function(){"use strict";angular.module("piecemeta-web.controllers.site",[]).controller("Site.Welcome",["$scope",function(a){a.$parent.status="ready"}]).controller("Site.About",["$scope",function(a){a.$parent.status="ready"
}]).controller("Site.Software",["$scope",function(a){a.$parent.status="ready"}])}(),function(){"use strict";angular.module("piecemeta-web.controllers.trackers",["piecemeta-web.services.api"]).controller("Trackers.Create",["$scope","apiService","$q","$location","$routeParams",function(a,b,c,d){a.tracker={title:null,description:null},a.formTitle="Create Tracker",a.submit=function(){var e=c.defer();a.promiseString="Saving...",a.promise=e.promise,b("trackers").actions.create(a.tracker,function(b,c){return b?(a.alerts=[{type:"danger",msg:"Failed to save tracker."}],void e.reject(b)):(a.alerts=[{type:"success",msg:"Successfully registered tracker."}],e.resolve(),void d.path("/trackers/"+c.id+"/edit"))})}}]).controller("Trackers.Edit",["$scope","$routeParams","$q","apiService",function(a,b,c,d){var e=c.defer();a.promiseString="Loading Tracker...",a.promise=e.promise,a.formTitle="Edit Tracker",d("trackers").actions.find(b.id,function(f,g){return f?(a.alerts=[{type:"danger",msg:"Failed to load tracker."}],e.reject(f),console.log("error getting tracker",f)):(a.tracker=g,e.resolve(),void(a.submit=function(){var e=c.defer();a.promiseString="Saving...",a.promise=e.promise,d("trackers").actions.update(b.id,a.tracker,function(b){return b?(console.log(b),a.alerts=[{type:"danger",msg:"Failed to update tracker."}],void e.reject(b)):(a.alerts=[{type:"success",msg:"Successfully updated tracker."}],void e.resolve())})}))})}]).controller("Trackers.List",["$scope","apiService",function(a,b){a.data={},b("trackers").actions.all(function(b,c){return b?console.log("error getting trackers",b):(a.data.trackers=c,void a.$apply())})}])}(),function(){"use strict";angular.module("piecemeta-web.controllers.users",["piecemeta-web.services.api","piecemeta-web.services.auth"]).controller("Users.Create",["$scope","$q","apiService",function(a,b,c){a.signup_complete=!1,a.alerts=[],a.user={name:null,email:null,password:null,password_confirm:null},a.closeAlert=function(b){a.alerts.splice(b,1)},a.$parent.status="ready",a.submit=function(){var d=b.defer();return a.promiseString="Registering...",a.promise=d.promise,a.$broadcast("show-errors-check-validity"),a.signupForm.$invalid?(a.alerts=[{type:"danger",msg:"Form is still invalid."}],void d.reject()):void c("users").actions.create(a.user,function(b,c){if(b){if(200!==b.status)if(a.alerts=[],c&&c.errors)for(var e in c.errors)"object"==typeof c.errors[e]&&a.alerts.push({type:"danger",msg:c.errors[e].message});else a.alerts=[{type:"danger",msg:"Server returned: "+b.status+" - "+b.code}];return void d.reject()}a.alerts=[{type:"success",msg:"Your account has been successfully created. Please check your E-Mails to complete the registration."}],a.signup_complete=!0,d.resolve()})}}]).controller("Users.Edit",["$scope","$q","apiService",function(a,b,c){var d=b.defer();a.alerts=[],a.user={name:null,email:null,avatar:null,password:null,password_confirm:null},a.closeAlert=function(b){a.alerts.splice(b,1)},a.submit=function(){var d=b.defer();return a.promiseString="Saving user...",a.promise=d.promise,a.$broadcast("show-errors-check-validity"),a.userForm.$invalid?(a.alerts=[{type:"danger",msg:"Form is still invalid."}],void d.reject()):(a.user.password&&0!==a.user.password.length&&a.user.password===a.user.password_confirm||(delete a.user.password,delete a.user.password_confirm),void c("users").actions.update("me",a.user,function(b){if(b){var c=[];if(409===b.status){var e=JSON.parse(b.message);for(var f in e)"object"==typeof e[f]&&c.push({type:"danger",msg:e[f].message})}else c=[{type:"danger",msg:"Server returned: "+b.status+" - "+b.code}];return a.alerts=c,void d.reject(b)}a.user.password=null,a.user.password_confirm=null,a.updateUser(),a.alerts=[{type:"success",msg:"Your account has been successfully updated."}],d.resolve()}))},a.promiseString="Loading user...",a.promise=d.promise,c("users").actions.find("me",function(b,c){b?(console.log("unable to get user",b),d.reject(b)):(a.user={name:c.name,email:c.email,avatar:c.avatar,password:null,password_confirm:null},d.resolve(c))})}]).controller("Users.Confirm",["$scope","$q","$location","$routeParams","apiService","authService",function(a,b,c,d,e){var f=b.defer();a.promiseString="Confirming user...",a.promise=f.promise,e("users/me/access_tokens").actions.create({single_access_token:d.single_access_token},function(b,c){return b?(a.alerts=[{type:"danger",msg:"Your account could not be confirmed."}],void f.reject(b)):void e().getCredentials(c,function(b){return b?(a.alerts=[{type:"danger",msg:"Your account could not be confirmed."}],void f.reject(b)):(a.alerts=[{type:"success",msg:"Your account has been successfully confirmed."}],a.updateUser(),void f.resolve())})})}]).controller("Users.Login",["$scope","$q","$location","apiService",function(a,b,c,d){a.alerts=[],a.user={email:null,password:null},a.$parent.status="ready",a.closeAlert=function(b){a.alerts.splice(b,1)},a.submit=function(){var e=b.defer();a.promiseString="Logging in...",a.promise=e.promise,d().authenticate(a.user.email,a.user.password,function(b){return b?(a.alerts=[{type:"danger",msg:"Login failed."}],void e.reject(b)):(a.updateUser(),e.resolve(),void c.path("/"))})}}]).controller("Users.Logout",["$scope","authService",function(a,b){b.clearCredentials(),window.location="/"}])}();