/**
 * piecemeta-angular-frontend - Angular-based web frontend for PieceMeta service
 * @version v0.9.4
 * @link http://www.piecemeta.com
 * @license MIT
 */
var PIECEMETA_DEV_API_URL="https://api.piecemeta.com",PIECEMETA_API_HOST="https://api.piecemeta.com";!function(){"use strict";angular.module("piecemeta-web.controllers.basic-resource",["piecemeta-web.services.api"]).controller("BasicResource.Create",["$scope","apiService","$q","$location",function(e,t,a,r){var n=r.path.split("/")[1].substr(0,r.path.split("/")[1].length-1);e.data={},e.formTitle="Create "+n,e.submit=function(){var o=a.defer();e.promiseString="Saving...",e.promise=o.promise,t(n+"s").actions.create(e.data,function(t,a){return t?(e.alerts=[{type:"danger",msg:"Failed to save "+n}],void o.reject(t)):(e.alerts=[{type:"success",msg:"Successfully created "+n}],o.resolve(),void r.path("/"+n+"s/"+a.uuid+"/edit"))})}}]).controller("BasicResource.Edit",["$scope","$routeParams","$q","apiService","$location",function(e,t,a,r,n){var o=n.path.split("/")[1].substr(0,n.path.split("/")[1].length-1),s=a.defer();e.promiseString="Loading...",e.promise=s.promise,e.formTitle="Edit "+o,r(o+"s").actions.find(t.uuid,function(n,i){return n?(e.alerts=[{type:"danger",msg:"Failed to load "+o}],s.reject(n),console.log("error getting "+o,n)):(e.data=i,s.resolve(),void(e.submit=function(){var n=a.defer();e.promiseString="Saving...",e.promise=n.promise,r(o+"s").actions.update(t.uuid,e.dataCollection,function(t){return t?(console.log(t),e.alerts=[{type:"danger",msg:"Failed to update "+o}],void n.reject(t)):(e.alerts=[{type:"success",msg:"Successfully updated "+o}],void n.resolve())})}))})}])}(),function(){"use strict";angular.module("piecemeta-web.controllers.channels",["angularFileUpload","piecemeta-web.services.api"]).controller("Channels.Create",["$scope","apiService","$q","$location","$routeParams",function(e,t,a,r,n){var o=a.defer();e.data={dataChannel:{package_uuid:n.package_uuid}},e.formTitle="Create channel",e.promiseString="Loading...",e.promise=o.promise,async.waterfall([function(e){t("packages").actions.find(n.package_uuid,e)},function(t,a){return t?(e.data.dataPackage=t,void a(null)):void a(new Error("No package found."))}],function(s){return s?(e.alerts=[{type:"danger",msg:"Failed to load package."}],void o.reject(s)):(o.resolve(),void(e.submit=function(){var o=a.defer();e.promiseString="Saving...",e.promise=o.promise,t("channels").actions.create(e.data.dataChannel,function(t){return t?(e.alerts=[{type:"danger",msg:"Failed to save channel."}],void o.reject(t)):(e.alerts=[{type:"danger",msg:"Successfully saved channel."}],o.resolve(),void r.path("/packages/edit/"+n.package_uuid))})}))})}]).controller("Channels.Edit",["$scope","$routeParams","$q","$location","apiService",function(e,t,a,r,n){var o=a.defer();e.data={},e.promiseString="Loading channel...",e.promise=o.promise,e.formTitle="Edit channel",async.waterfall([function(e){n("channels").actions.find(t.uuid,e)},function(t,a){return t?(e.data.dataChannel=t,e.formTitle='Edit "'+t.title+'"',void a(null)):void a(new Error("No channel found."))},function(t){n("packages").actions.find(e.data.dataChannel.package_uuid,t)},function(t,a){return t?(e.data.dataPackage=t,void a(null)):void a(new Error("No package found."))},function(e){n("channels/"+t.uuid+"/streams").actions.all(e)},function(t,a){t.length>0&&(e.data.dataStreams=t.sort(function(e,t){return e.group<t.group?-1:e.group>t.group?1:0})),a(null)}],function(s){return s?(e.alerts=[{type:"danger",msg:"Failed to load channel."}],void o.reject(s)):(o.resolve(),e.$apply(),e.deleteStream=function(t,r){if(r.preventDefault(),window.confirm("Do you really want to delete this stream?")){var o=a.defer();e.promiseString="Deleting data stream...",e.promise=o.promise,e.data.dataStreams.splice(e.data.dataStreams.indexOf(t),1),n("streams").actions.remove(t.uuid,function(t){return t?(e.alerts=[{type:"danger",msg:"Failed to delete stream."}],o.reject(t),console.log("error deleting stream",t)):(e.alerts=[{type:"success",msg:"Successfully saved stream."}],o.resolve(),void e.$apply())})}},e.deleteCurrentItem=function(){if(window.confirm("Do you really want to delete this channel and all attached streams?")){var o=a.defer();e.promiseString="Deleting channel and streams...",e.promise=o.promise,async.waterfall([function(e){n("channels/"+t.uuid+"/streams").actions.all(function(t,a){async.each(a,function(e,t){n("streams").actions.remove(e.uuid,t)},e)})},function(e){n("channels").actions.remove(t.uuid,e)}],function(t){return t?(e.alerts=[{type:"danger",msg:"Failed to delete channel."}],o.reject(t),console.log("error deleting channel",t)):(o.resolve(),void r.path("/packages/"+e.data.dataPackage.uuid+"/edit"))})}},void(e.submit=function(){var r=a.defer();e.promiseString="Saving...",e.promise=r.promise,n("channels").actions.update(t.uuid,e.data.dataChannel,function(t){return t?(console.log(t),e.alerts=[{type:"danger",msg:"Failed to update channel."}],void r.reject(t)):(r.resolve(),void(e.alerts=[{type:"success",msg:"Successfully updated channel."}]))})}))})}])}(),function(){"use strict";angular.module("piecemeta-web.controllers.packages",["angularFileUpload","piecemeta-web.services.api","piecemeta-web.services.importers.json","piecemeta-web.services.importers.bvh","chartjs"]).controller("Packages.ImportBVH",["$scope","$q","bvhImportService",function(e,t,a){e.file=null,e.onFileSelect=function(r){var n=t.defer();e.promiseString="Importing data...",e.promise=n.promise,e.file=r[0],e.dataPackage=null;var o=new FileReader;o.onload=function(t){a.parse(t.target.result,r[0].name,function(t,a){return t?(console.log("error processing bvh file",t),void n.reject(t)):(e.dataPackage=a,console.log("successfully processed bvh file",a),void n.resolve())})},o.readAsText(r[0])}}]).controller("Packages.ImportJSON",["$scope","$q","$routeParams","jsonImportService",function(e,t,a,r){e.file=null,e.onFileSelect=function(n){var o=t.defer();e.promiseString="Importing data...",e.promise=o.promise,e.file=n[0],e.dataPackage=null;var s=new FileReader;s.onload=function(t){console.log("onload"),r.parse(t.target.result,n[0].name,a.garbage,function(t,a){return t?(console.log("error processing json file",t),void o.reject(t)):(e.dataPackage=a,console.log("successfully processed json file",a),void o.resolve())})},s.readAsText(n[0])}}]).controller("Packages.Show",["$scope","$q","$routeParams","apiService",function(e,t,a,r){function n(t){"object"==typeof e.data.currentChannel?(o={},async.each(e.data.currentChannel.streams,function(t,a){if(console.log(e.data.currentGroup,t.group),!e.data.currentGroup||e.data.currentGroup&&e.data.currentGroup===t.group){var n;t.frameCount>100&&(n={skip:Math.floor(t.frameCount/100)}),r("streams",null,n).actions.find(t.uuid,function(e,r){o[t.uuid]=r.frames,window.setTimeout(function(){a(e)},0)})}else a()},function(e){"function"==typeof t&&t(e)})):"function"==typeof t&&t()}var o={};e.data={streamGroups:[],dataPackage:null,currentGroup:null,channelIndex:0,chartSetup:{graphOptions:{showTooltips:!0,scaleShowLabels:!0,animation:!1,responsive:!0,pointDot:!1,bezierCurve:!1,scaleShowGridLines:!1,datasetFill:!1,legend:!0}},exports:{json:PIECEMETA_API_HOST+"/exports/"+a.uuid+".json",msgpack:PIECEMETA_API_HOST+"/exports/"+a.uuid+".msgpack",xml:PIECEMETA_API_HOST+"/exports/"+a.uuid+".xml"}},e.updateTimeout=null;var s=t.defer();e.promiseString="Loading data...",e.promise=s.promise,e.onURLClick=function(e){e.target.select()},e.updateChart=function(){var t={},a=0,r=null,n=["#ff0000","#732e00","#b2a159","#435946","#b6def2","#8660bf","#ff0088","#e50000","#331c0d","#d6e600","#40ffa6","#0066bf","#a38fbf","#4c0029","#d90000","#ffb380","#494d13","#269973","#80b3ff","#442d59","#99003d","#590000","#a67453","#818c69","#b6f2de","#434c59","#33004d","#bf6086","#d96c6c","#ffd9bf","#81f200","#005359","#334166","#a300cc","#d9003a","#332626","#cc8800","#448000","#36ced9","#263699","#fbbfff","#e6acbb","#7f2d20","#7f5500","#d6f2b6","#698a8c","#3d3df2","#cc33ad","#733941","#8c7369","#665533","#8fcc66","#002b40","#140099","#664d61","#ff6600","#ffcc00","#17330d","#308fbf","#120d33","#802060"];if(e.data.streamGroups=[],r=e.data.currentChannel){for(var s=Math.floor(8*Math.random()),i=0;i<r.streams.length;i+=1)if("object"==typeof o[r.streams[i].uuid]&&o[r.streams[i].uuid].length>0){var l=o[r.streams[i].uuid];if("object"==typeof r.streams[i]){for(var c=(r.streams[i].group?r.streams[i].group+"/":"")+r.streams[i].title,u=[],d=0;3>d;d+=1)u.push(Math.round(100*Math.random())+100);var p=n.splice(s,1),f={label:c,strokeColor:p,highlightStroke:p,pointColor:p,data:l};f.data.length>a&&(a=f.data.length),(!e.data.currentGroup||e.data.currentGroup&&e.data.currentGroup===r.streams[i].group)&&(t[c]=f),e.data.streamGroups.indexOf(r.streams[i].group)<0&&e.data.streamGroups.push(r.streams[i].group)}}else console.log("empty stream");var m=[],g=[];for(var h in t)"object"==typeof t[h]&&m.push(t[h]);for(var v=1;a>=v;v+=1)g.push("");e.data.streamGroups=e.data.streamGroups.sort(),e.data.currentGroup||(e.data.currentGroup=e.data.streamGroups[0]);var y={labels:g,datasets:m};e.data.chartSetup.graphDataSet=y}},async.waterfall([function(e){r("packages").actions.find(a.uuid,e)},function(e,t){r("users").actions.find(e.user_uuid,function(a,r){t(a,e,r)})},function(t,a,r){e.data.dataPackage=t,e.data.packageAuthor=a,e.data.dataURL=PIECEMETA_API_HOST+"/packages/"+t.uuid,r(null)},function(t){r("packages/"+e.data.dataPackage.uuid+"/channels").actions.all(t)},function(t,a){e.data.dataPackage.channels=t.sort(function(e,t){return e.title<t.title?-1:e.title>t.title?1:0}),a(null)},function(t){async.eachSeries(e.data.dataPackage.channels,function(t,a){r("channels/"+t.uuid+"/streams").actions.all(function(r,n){return r?a(r):(e.data.dataPackage.channels[e.data.dataPackage.channels.indexOf(t)].streams=n,void a())})},function(e){t(e)})},function(a){e.$watch("data.currentChannel",function(){var a=t.defer();e.chartPromise=a.promise,n(function(t){t&&console.log("error getting stream data",t),e.updateChart(),a.resolve()})},!0),e.$watch("data.currentGroup",function(){e.updateChart(),s.resolve()},!0),a(null)}],function(t){return t?(s.reject(t),console.log("error getting data",a,t),void(e.$parent.status="ready")):(e.$apply(),s.resolve(),void(e.$parent.status="ready"))})}]).controller("Packages.List",["$scope","apiService",function(e,t){e.data={},t("packages").actions.all(function(t,a){return t?console.log("error getting packages",t):(e.data.data_packages=a.sort(function(e,t){return e.title<t.title?-1:e.title>t.title?1:0}),void e.$apply())})}]).controller("Packages.Create",["$scope","apiService","$q","$location",function(e,t,a,r){e.dataPackage={title:null,description:null,contributor_uuid:null},e.formTitle="Create package",e.submit=function(){var n=a.defer();e.promiseString="Saving...",e.promise=n.promise,t("packages").actions.create(e.dataPackage,function(t,a){return t?(e.alerts=[{type:"danger",msg:"Failed to save Package."}],void n.reject(t)):(e.alerts=[{type:"success",msg:"Successfully saved Package."}],n.resolve(),void r.path("/packages/"+a.uuid+"/edit"))})}}]).controller("Packages.Edit",["$scope","$routeParams","$q","$location","apiService",function(e,t,a,r,n){var o=a.defer();e.promiseString="Loading Package...",e.promise=o.promise,e.formTitle="Edit package",e.deleteChannel=function(t,r){if(r.preventDefault(),window.confirm("Do you really want to delete this channel and all attached streams?")){var o=a.defer();e.promiseString="Deleting channel and streams...",e.promise=o.promise,async.waterfall([function(e){n("channels/"+t.uuid+"/streams").actions.all(function(t,a){async.each(a,function(e,t){n("streams").actions.remove(e.uuid,t)},e)})},function(e){n("channels").actions.remove(t.uuid,e)}],function(a){return a?(e.alerts=[{type:"danger",msg:"Failed to delete channel."}],o.reject(a),console.log("error deleting channel",a)):(o.resolve(),e.dataChannels.splice(e.dataChannels.indexOf(t),1),void e.$apply())})}},e.deleteCurrentItem=function(){if(window.confirm("Do you really want to delete this package and all attached channels and streams?")){var o=a.defer();e.promiseString="Deleting package, channels and streams...",e.promise=o.promise,async.waterfall([function(e){n("packages/"+t.uuid+"/channels").actions.all(e)},function(e,t){async.each(e,function(e,t){n("channels/"+e.uuid+"/streams").actions.all(function(a,r){async.each(r,function(e,t){n("streams").actions.remove(e.uuid,t)},function(a){a?t(a):n("channels").actions.remove(e.uuid,t)})})},t)},function(e){n("packages").actions.remove(t.uuid,e)}],function(t){return t?(e.alerts=[{type:"danger",msg:"Failed to delete package."}],o.reject(t),console.log("error deleting package",t)):(o.resolve(),void r.path("/packages/browse"))})}},e.submit=function(){var r=a.defer();e.promiseString="Saving...",e.promise=r.promise,n("packages").actions.update(t.uuid,e.dataPackage,function(t){return t?(console.log(t),e.alerts=[{type:"danger",msg:"Failed to update Package."}],void r.reject(t)):(r.resolve(),void(e.alerts=[{type:"success",msg:"Successfully updated Package."}]))})},n("packages").actions.find(t.uuid,function(t,a){return t?(e.alerts=[{type:"danger",msg:"Failed to load Package."}],o.reject(t),console.log("error getting package",t)):(e.dataPackage=a,e.formTitle='Edit "'+a.title+'"',void n("packages/"+a.uuid+"/channels").actions.all(function(t,a){return t?(e.alerts=[{type:"danger",msg:"Failed to load Channels."}],o.reject(t),console.log("error getting channels",t)):(a.length>0&&(e.dataChannels=a.sort(function(e,t){return e.title<t.title?-1:e.title>t.title?1:0})),o.resolve(),void e.$apply())}))})}])}(),function(){"use strict";angular.module("piecemeta-web.controllers.streams",["angularFileUpload","piecemeta-web.services.api","piecemeta-web.services.importers.text","piecemeta-web.services.importers.trac"]).controller("Streams.Create",["$scope","apiService","$q","$location","$routeParams",function(e,t,a,r,n){e.data={dataStream:{channel_uuid:n.uuid}};var o=a.defer();e.promiseString="Loading...",e.promise=o.promise,e.formTitle="Create stream",async.waterfall([function(e){t("channels").actions.find(n.uuid,e)},function(t,a){return t?(e.data.dataChannel=t,e.formTitle='Edit "'+t.title+'"',void a(null)):void a(new Error("No channel found."))},function(a){t("packages").actions.find(e.data.dataChannel.package_uuid,a)},function(t,a){return t?(e.data.dataPackage=t,void a(null)):void a(new Error("No package found."))}],function(n){return n?(e.alerts=[{type:"danger",msg:"Failed to load channel."}],void o.reject(n)):void(e.submit=function(){var n=a.defer();e.promiseString="Saving...",e.promise=n.promise,t("streams").actions.create(e.dataStream,function(t,a){return t?(e.alerts=[{type:"danger",msg:"Failed to save stream."}],void n.reject(t)):(e.alerts=[{type:"success",msg:"Successfully saved stream."}],n.resolve(),void r.path("/streams/"+a.uuid+"/edit"))})})})}]).controller("Streams.Edit",["$scope","$routeParams","$q","$location","apiService",function(e,t,a,r,n){var o=a.defer();e.data={},e.promiseString="Loading stream...",e.promise=o.promise,e.formTitle="Edit stream",async.waterfall([function(e){n("streams").actions.find(t.uuid,e)},function(t,a){return t?(e.data.dataStream=t,e.formTitle='Edit "'+t.title+'"',void a(null)):void a(new Error("No stream found."))},function(t){n("channels").actions.find(e.data.dataStream.channel_uuid,t)},function(t,a){return t?(e.data.dataChannel=t,void a(null)):void a(new Error("No channel found."))},function(t){n("packages").actions.find(e.data.dataChannel.package_uuid,t)},function(t,a){return t?(e.data.dataPackage=t,void a(null)):void a(new Error("No package found."))}],function(s){return s?(e.alerts=[{type:"danger",msg:"Failed to load stream."}],o.reject(s),console.log("error getting stream",s)):(o.resolve(),e.submit=function(){var r=a.defer();e.promiseString="Saving...",e.promise=r.promise,n("streams").actions.update(t.uuid,e.data.dataStream,function(t){return t?(console.log(t),e.alerts=[{type:"danger",msg:"Failed to update data stream."}],void r.reject(t)):(e.alerts=[{type:"success",msg:"Successfully updated stream."}],void r.resolve())})},e.deleteCurrentItem=function(){if(window.confirm("Do you really want to delete this stream?")){var o=a.defer();e.promiseString="Deleting data stream...",e.promise=o.promise,n("streams").actions.remove(t.uuid,function(t){return t?(e.alerts=[{type:"danger",msg:"Failed to delete stream."}],o.reject(t),console.log("error deleting stream",t)):(o.resolve(),void r.path("/channels/"+e.data.dataChannel.uuid+"/edit"))})}},void(e.onFileSelect=function(t){var a=new FileReader;a.onload=function(t){var a;try{a=JSON.parse(t.target.result)}catch(r){return console.log("error parsing json",r),void(e.alerts=[{type:"danger",msg:"Error parsing JSON"}])}"object"==typeof a&&a.length>0&&"number"==typeof a[0]?e.dataStream.data_frames=a:e.alerts=[{type:"danger",msg:"JSON is not in the required format"}]},a.readAsText(t[0])}))})}]).controller("Streams.ImportFile",["$scope","$q","$routeParams","$location","apiService","textImportService",function(e,t,a,r,n,o){var s,i,l=t.defer();e.data={regex:null,dataPackage:null,selectedChannel:{},startFrame:1,regexString:"",regexPresets:[{title:"3 Numbers separated by space",data:"([-+]?[0-9]*\\.?[0-9]+) ([-+]?[0-9]*\\.?[0-9]+) ([-+]?[0-9]*\\.?[0-9]+)"},{title:"3 Numbers separated by semicolon",data:"([-+]?[0-9]*\\.?[0-9]+);([-+]?[0-9]*\\.?[0-9]+);([-+]?[0-9]*\\.?[0-9]+)"},{title:"2 Numbers separated by comma and enclosed in quotes",data:'"([-+]?[0-9]*\\.?[0-9]+)","([-+]?[0-9]*\\.?[0-9]+)"'}],channelTitle:"",resultLines:[],fileLines:[],isComplete:!1,valLength:0,valLabel:[]},e.frameCount=0,e.promiseString="Loading...",e.promise=l.promise,async.waterfall([function(e){n("packages").actions.find(a.uuid,e)},function(t,a){t?(e.data.dataPackage=t,a(null)):a(new Error("package not found"))},function(e){n("packages/"+a.uuid+"/channels").actions.all(e)},function(t,a){t?(e.data.dataChannels=t,a(null)):a(new Error("no channels found"))}],function(e){return e?(console.log("error getting package",e),void l.reject(e)):void l.resolve()}),e.updateRegex=function(t){if(t&&""!==t){e.data.regex=new RegExp(t,"gm");var a=o.applyRegex(i,e.data.regex);e.data.resultLines=a.frames,e.data.valLength=a.valLength,e.data.valLabel=[];for(var r=0;r<e.data.valLength;r+=1)e.data.valLabel.push("")}},e.onFileSelect=function(a){var r=t.defer();e.promiseString="Reading file...",e.promise=r.promise;var n=new FileReader;n.onload=function(t){s=t.target.result,e.data.fileLines=s.split("\n").splice(0,10);var a=o.parse(s,e.data.startFrame,10);e.frameCount=a.frameCount,i=a.frames,e.updateRegex(e.data.regexString),e.$apply(),r.resolve()},n.readAsText(a[0])},e.submit=function(){var n=t.defer();return e.promiseString="Adding channel...",e.promise=n.promise,e.$broadcast("show-errors-check-validity"),e.channelImportForm.$invalid?(e.alerts=[{type:"danger",msg:"You have to at least enter a title, frame rate and value titles."}],void n.reject()):void o.submit(s,e.data,function(t){return t?(e.alerts=[{type:"danger",msg:"Failed to add streams"}],console.log("failed to create streams",t),void n.reject()):(e.alerts=[{type:"danger",msg:"Successfully added streams"}],r.path("/packages/"+a.uuid+"/edit"),void n.resolve())})}}]).controller("Streams.ImportTrac",["$scope","$q","apiService","$routeParams","$location","tracImportService",function(e,t,a,r,n,o){var s="",i=t.defer();e.data={dataPackage:null,dataChannels:null,dataStreams:[],selectedChannel:{},channelTitle:"",startFrame:1,fps:null,resultLines:[],frameCount:0,valLength:0,valLabel:[],fileLines:[],isComplete:!1},e.promiseString="Loading...",e.promise=i.promise,async.waterfall([function(e){a("packages").actions.find(r.uuid,e)},function(t,a){t?(e.data.dataPackage=t,a(null)):a(new Error("package not found"))},function(e){a("packages/"+r.uuid+"/channels").actions.all(e)},function(t,a){t?(e.data.dataChannels=t,a(null)):a(new Error("no channels found"))}],function(e){return e?(console.log("error getting package",e),void i.reject(e)):void i.resolve()}),e.onFileSelect=function(a){var r=t.defer();e.promiseString="Reading file...",e.promise=r.promise;var n=new FileReader;n.onload=function(t){s=t.target.result,o.parse(t.target.result,e.data,function(t,a){a>0&&(e.alerts=[{type:"warning",msg:"The data contains "+a+" line(s) containing a different number of values than labels."}]),r.resolve(),e.$apply()})},n.readAsText(a[0])},e.submit=function(){var a=t.defer();return e.promiseString="Adding channel...",e.promise=a.promise,e.$broadcast("show-errors-check-validity"),e.tracImportForm.$invalid?(e.alerts=[{type:"danger",msg:"You have to at least enter a title, frame rate and value titles."}],void a.reject()):void o.submit(e.data,function(t){return t?(e.alerts=[{type:"danger",msg:"Failed to add streams"}],console.log("failed to create streams",t),void a.reject()):(e.alerts=[{type:"danger",msg:"Successfully added streams"}],n.path("/packages/"+r.uuid+"/edit"),void a.resolve())})}}])}(),angular.module("piecemeta-web.directives.helpers",["piecemeta-web.services.api","piecemeta-web.services.auth"]).directive("checkLogin",["apiService","authService",function(e,t){"use strict";return{link:function(a){a.updateUser=function(){t.access_token&&e("users").actions.find("me",function(e,t){return e?(console.log("error fetching user",e),void(a.userSession=null)):(a.userSession=t,void a.$apply())})},a.updateUser()}}}]),angular.module("piecemeta-web.services.api",[]).factory("apiService",["authService",function(e){"use strict";return function(t,a,r){var n=new PMApi({host:a?a:PIECEMETA_API_HOST,contentType:"application/json",api_key:e.api_key,access_token:e.access_token});return{client:n,actions:{all:function(e,a){n.resource(t,r).action("get",null,e,a)},find:function(e,a,o){n.resource(t,r).action("get",e,a,o)},create:function(e,a,r){n.resource(t).action("post",e,a,r)},update:function(e,a,r,o){a.uuid=e,n.resource(t).action("put",a,r,o)},remove:function(e,a,r){n.resource(t).action("delete",e,a,r)}},getCredentials:function(t,a){n.setToken(t),n.getCredentials(function(r,n){return r?a(r):void("object"==typeof n?(e.setCredentials(n,t),a(null)):a(new Error("Failed to get credentials")))})},authenticate:function(t,a,r){n.getToken({email:t,password:a},function(t,a){return t?r(t):void("object"==typeof a?n.getCredentials(function(t,n){return t?r(t):void("object"==typeof n?(e.setCredentials(n,a),r(null)):r(new Error("Failed to get credentials")))}):r(new Error("Failed to get token")))})}}}}]),function(){"use strict";angular.module("piecemeta-web.services.auth",[]).factory("authService",["$http",function(){var e={api_key:null,access_token:null,getCredentials:function(){e.api_key="string"==typeof localStorage.api_key?JSON.parse(localStorage.api_key):null,e.access_token="string"==typeof localStorage.access_token?JSON.parse(localStorage.access_token):null},setCredentials:function(t,a){localStorage.api_key=JSON.stringify(t),localStorage.access_token=JSON.stringify(a),e.getCredentials()},clearCredentials:function(){localStorage.removeItem("api_key"),localStorage.removeItem("access_token"),e.getCredentials()}};return e.getCredentials(),e}])}(),angular.module("piecemeta-web.services.importers.bvh",["piecemeta-web.services.api"]).factory("bvhImportService",["apiService",function(e){"use strict";return{parse:function(t,a,r){var n,o;async.waterfall([function(e){e(null,BVH.parse(t))},function(e,t){o=e,t(null)},function(t){var r={title:a};e("packages").actions.create(r,function(e,a){t(e,a)})},function(e,t){n=e,n.channels=[],t(null)},function(t){async.eachSeries(o.nodeList,function(t,a){var r={title:t.id,package_uuid:n.uuid};e("channels").create(r,function(r,s){if(r)return a(r);n.channels.push(s);var i=[{title:"x",group:"position",value_offset:t.offsetX},{title:"y",group:"position",value_offset:t.offsetY},{title:"z",group:"position",value_offset:t.offsetZ},{title:"z",group:"rotation"},{title:"y",group:"rotation"},{title:"x",group:"rotation"}];for(var l in i)"object"==typeof i[l]&&(i[l].frames=[],i[l].fps=parseFloat((1/o.frameTime).toFixed(2)));for(var c in t.frames)if("object"==typeof t.frames[c]){var u=t.frames[c];for(var d in u)"number"==typeof u[d]&&i[d].frames.push(u[d])}async.eachSeries(i,function(t,a){t.channel_uuid=s.uuid,e("streams").actions.create(t,function(e){a(e)})},function(e){a(e)})})},function(e){t(e)})},function(t){async.eachSeries(n.channels,function(t,a){for(var r=0,s=o.nodeList;s[r].id!==t.title&&r<s.length;)r+=1;if(s[r].parent){for(var i=0;n.channels[i].title!==s[r].parent.id&&i<n.channels.length;)i+=1;t.parent_channel_uuid=n.channels[i].uuid,e("channels").actions.update(t.uuid,t,function(e){a(e)})}else a(null)},function(e){t(e)})}],r)}}}]),angular.module("piecemeta-web.services.importers.json",["piecemeta-web.services.api"]).factory("jsonImportService",["apiService",function(e){"use strict";return{parse:function(t,a,r,n){var o;async.waterfall([function(e){var a;try{a=JSON.parse(t),e(null,a)}catch(r){e(new Error("error parsing json: "+r.toString()),null)}},function(e,t){var a;if(r){var n=0,o={};for(a in e)"object"==typeof e[a]&&e[a].length>0&&e[a].length>n&&(n=e[a].length);console.log("max frame is",n);for(a in e)if("object"==typeof e[a]&&e[a].length>0&&(o[a]=[],e[a].length<n)){var s=n-e[a].length,i=Math.ceil(n/s),l=0;console.log("extend",e[a].length,s,i);for(var c=0;c<e[a].length;c+=1)e[a][c]&&(o[a].push(e[a][c]),s>l&&(o[a].push(e[a][c]),l+=1));for(;o[a].length<n;)o[a].push(e[a][e[a].length-1])}t(null,o)}else{var u=1e3/60,d={};for(a in e)if("object"==typeof e[a]&&e[a].length>0){var p=1e3*e[a][0].m+e[a][0].s;d[a]=[],console.log("frames",e[a].length);for(var f in e[a])if("object"==typeof e[a][f]){for(var m=1e3*e[a][f].m+e[a][f].s,g=Math.round((m-p)/u),h=0;g>h;h+=1){var v=h*u,y=m+v;d[a].push({a:e[a][f].a,m:Math.floor(y/1e3),s:1e3*(y/1e3-Math.floor(y/1e3))})}p=m}}t(null,d)}},function(e,t){var a;if(r){for(a in e)"object"==typeof e[a]&&e[a].length>0&&console.log(a,e[a].length);t(null,e)}else{var n={},o=1e3/60;for(a in e)if("object"==typeof e[a]&&e[a].length>0){var s=0,i=1e3*e[a][0].m+e[a][0].s;n[a]=[],console.log("frames",e[a].length);for(var l in e[a])if("object"==typeof e[a][l]){var c=1e3*e[a][l].m+e[a][l].s,u=Math.round((c-i)/o);1!==u?(s+=1,console.log("dropped faulty frame with diff != 1at",u,l)):n[a].push(e[a][l]),i=c}console.log("total faults",s)}t(null,n)}},function(e,t){if(r)t(null,e);else{var a=1e3/60;for(var n in e)if("object"==typeof e[n]&&e[n].length>0){var o=0,s=1e3*e[n][0].m+e[n][0].s;console.log("cleaned frames for index",n,e[n].length);for(var i in e[n])if("object"==typeof e[n][i]){var l=1e3*e[n][i].m+e[n][i].s,c=Math.round((l-s)/a);1!==c&&(o+=1),s=l}console.log("total faults",o)}t(null,e)}},function(t,r){var n={title:a};e("packages").actions.create(n,function(e,a){r(e,a,t)})},function(e,t,a){o=e,o.channels=[],a(null,t)},function(e,t){for(var a in e)if("object"==typeof e[a]&&e[a].length>0){for(var r={title:a.substr(1,a.length-1),id:null,package_uuid:o.uuid,streams:[]},n=e[a][0].a.length,s=0;n>s;s+=1)r.streams.push({id:null,fps:60,channel_id:null,title:"p"+s.toString(),group:n>1?"grouped":null,frames:[]});for(var i in e[a])if("object"==typeof e[a][i])for(var l=0;n>l;l+=1)r.streams[l].frames.push(e[a][i].a[l]);o.channels.push(r)}t(null)},function(t){async.eachSeries(o.channels,function(t,a){t.package_uuid=o.uuid,e("channels").actions.create(t,function(r,n){return r?a(r):(o.channels[o.channels.indexOf(t)].uuid=n.uuid,void async.eachSeries(o.channels[o.channels.indexOf(t)].streams,function(t,a){t.channel_uuid=n.uuid,e("streams").actions.create(t,function(e){a(e)})},function(e){a(e)}))})},function(e){t(e)})}],n)}}}]),angular.module("piecemeta-web.services.importers.text",["piecemeta-web.services.api"]).factory("textImportService",["apiService",function(e){"use strict";return{parse:function(e,t,a){var r=e.split("\n"),n=r.length,o=r.slice(Math.abs(parseInt(t)),a);return{frames:o,frameCount:n}},applyRegex:function(e,t){if(t){var a=[],r=0;for(var n in e)if("string"==typeof e[n]){for(var o=null,s=[];null!==(o=t.exec(e[n]));)s=o;s.shift(),r<s.length&&(r=s.length),a.push(s)}return{frames:a,valLength:r}}},submit:function(t,a,r){var n=[],o=t.split("\n");async.waterfall([function(e){for(var t=0;t<a.valLength;t+=1){var r={channel_uuid:a.selectedChannel.uuid,title:a.valLabel[t],fps:a.fps,group:a.valueGroup,frames:[]};n.push(r)}e(null)},function(e){for(var t in o)if("string"==typeof o[t]){for(var r=null,s=[];null!==(r=a.regex.exec(o[t]));)s=r;s.shift();for(var i in s)"object"==typeof n[i]&&n[i].frames.push(s[i])}e(null)},function(t){if(a.selectedChannel.uuid)t(null,null);else{var r={package_uuid:a.dataPackage.uuid,title:a.selectedChannel.title?a.selectedChannel.title:a.channelTitle};e("channels").actions.create(r,t)}},function(e,t){t(null,a.selectedChannel.uuid||e.uuid)},function(t,a){async.eachSeries(n,function(a,r){a.channel_uuid=t,e("streams").actions.create(a,r)},function(e){a(e)})}],r)}}}]),angular.module("piecemeta-web.services.importers.trac",["piecemeta-web.services.api"]).factory("tracImportService",["apiService",function(e){"use strict";return{parse:function(e,t,a){var r=Papa.parse(e).data,n=r.splice(0,5),o=n[3];o.splice(0,1);var s=n[4];for(s.splice(0,2);null===s[s.length-1]||""===s[s.length-1];)s.pop();var i=s.length+1;o=o.filter(function(e){return""!==e});var l=0;async.waterfall([function(e){t.fps=parseFloat(n[2][0]),t.frameCount=r.length,t.fileLines=r.slice(Math.abs(parseInt(t.startFrame)),10),e()},function(e){var a={channel_uuid:t.selectedChannel.uuid,title:o.shift(),frames:[],fps:t.fps};t.dataStreams.push(a),e()},function(e){async.eachSeries(o,function(e,a){var r=s.splice(0,3);async.each(r,function(a,r){var n={channel_uuid:t.selectedChannel.uuid,title:a.replace(/[0-9]/g,""),group:e,frames:[],fps:t.fps};t.dataStreams.push(n),r()},function(e){a(e)})},e)},function(e){for(var a in r)if("object"==typeof r[a]){var n=r[a];n.splice(0,1),i!==n.length&&(l+=1);for(var o=0;i>o;o+=1)"undefined"==typeof n[o]?t.dataStreams[o].frames.push(null):t.dataStreams[o].frames.push(parseFloat(n[o]))}e()}],function(e){a(e,l)})},submit:function(t,a){async.waterfall([function(a){if(t.selectedChannel.uuid)a(null,null);else{var r={package_uuid:t.dataPackage.uuid,title:t.selectedChannel.title?t.selectedChannel.title:t.channelTitle};e("channels").actions.create(r,a)}},function(e,a){a(null,t.selectedChannel.uuid||e.uuid)},function(a,r){async.eachSeries(t.dataStreams,function(t,r){t.channel_uuid=a,e("streams").actions.create(t,r)},function(e){r(e)})}],a)}}}]),function(){"use strict";angular.module("piecemeta-frontend",["ui.bootstrap","ngRoute","cgBusy","btford.markdown","piecemeta-web.controllers.site","piecemeta-web.controllers.users","piecemeta-web.controllers.packages","piecemeta-web.controllers.channels","piecemeta-web.controllers.streams","piecemeta-web.directives.helpers"]).config(["$routeProvider","$locationProvider","$logProvider",function(e,t,a){a.debugEnabled(!0),t.html5Mode(!0).hashPrefix("!");var r="partials/";e.when("/",{templateUrl:r+"welcome.html",controller:"Site.Welcome"}),e.when("/about",{templateUrl:r+"about.html",controller:"Site.About"}),e.when("/software",{templateUrl:r+"software.html",controller:"Site.Software"}),e.when("/signup",{templateUrl:r+"signup.html",controller:"Users.Create"}),e.when("/me/account",{templateUrl:r+"account.html",controller:"Users.Edit"}),e.when("/confirm/:single_access_token",{templateUrl:r+"confirm",controller:"Users.Confirm"}),e.when("/login",{templateUrl:r+"login.html",controller:"Users.Login"}),e.when("/logout",{templateUrl:r+"logout.html",controller:"Users.Logout"}),e.when("/packages/browse",{templateUrl:r+"packages_browse.html",controller:"Packages.List"}),e.when("/packages/:uuid/channels/import/csv",{templateUrl:r+"streams_import.html",controller:"Streams.ImportFile"}),e.when("/packages/:uuid/channels/import/trac",{templateUrl:r+"streams_import_trac.html",controller:"Streams.ImportTrac"}),e.when("/packages/upload",{templateUrl:r+"packages_upload.html",controller:"Packages.ImportBVH"}),e.when("/packages/uploadjson",{templateUrl:r+"packages_upload_json.html",controller:"Packages.ImportJSON"}),e.when("/packages/create",{templateUrl:r+"packages_edit.html",controller:"Packages.Create"
}),e.when("/packages/:uuid/edit",{templateUrl:r+"packages_edit.html",controller:"Packages.Edit"}),e.when("/packages/:uuid/show",{templateUrl:r+"packages_show.html",controller:"Packages.Show"}),e.when("/collections/create",{templateUrl:r+"collections_edit.html",controller:"BasicResource.Create"}),e.when("/collections/:uuid/edit",{templateUrl:r+"collections_edit.html",controller:"BasicResource.Edit"}),e.when("/channels/:uuid/streams/create",{templateUrl:r+"streams_edit.html",controller:"Streams.Create"}),e.when("/streams/:uuid/edit",{templateUrl:r+"streams_edit.html",controller:"Streams.Edit"}),e.when("/packages/:package_uuid/channels/create",{templateUrl:r+"channels_edit.html",controller:"Channels.Create"}),e.when("/channels/:uuid/edit",{templateUrl:r+"channels_edit.html",controller:"Channels.Edit"}),e.when("/trackers",{templateUrl:r+"trackers_list.html",controller:"Trackers.List"}),e.when("/trackers/create",{templateUrl:r+"trackers_edit.html",controller:"BasicResource.Create"}),e.when("/trackers/:uuid/edit",{templateUrl:r+"trackers_edit.html",controller:"BasicResource.Edit"}),e.otherwise({redirectTo:"/"})}]).run(["$rootScope","$q",function(e,t){Modernizr.localstorage&&Modernizr.canvas&&Modernizr.hashchange&&Modernizr.fontface||window.alert("Your browser is too old or not compatible with this website. It may still work, but most likely won't."),e.$on("$routeChangeStart",function(){e.pageDefer=t.defer(),e.pagePromise=e.pageDefer.promise}),e.$on("$routeChangeSuccess",function(){e.pageDefer.resolve()}),e.$on("$routeChangeError",function(){e.pageDefer.reject()})}])}(),function(){"use strict";angular.module("piecemeta-web.controllers.site",[]).controller("Site.Welcome",["$scope",function(e){e.$parent.status="ready"}]).controller("Site.About",["$scope",function(e){e.$parent.status="ready"}]).controller("Site.Software",["$scope",function(e){e.$parent.status="ready"}])}(),function(){"use strict";angular.module("piecemeta-web.controllers.trackers",["piecemeta-web.services.api"]).controller("Trackers.List",["$scope","apiService",function(e,t){e.data={},t("trackers").actions.all(function(t,a){return t?console.log("error getting trackers",t):(e.data.trackers=a,void e.$apply())})}])}(),function(){"use strict";angular.module("piecemeta-web.controllers.users",["piecemeta-web.services.api","piecemeta-web.services.auth"]).controller("Users.Create",["$scope","$q","apiService",function(e,t,a){e.signup_complete=!1,e.alerts=[],e.user={name:null,email:null,password:null,password_confirm:null},e.closeAlert=function(t){e.alerts.splice(t,1)},e.$parent.status="ready",e.submit=function(){var r=t.defer();return e.promiseString="Registering...",e.promise=r.promise,e.$broadcast("show-errors-check-validity"),e.signupForm.$invalid?(e.alerts=[{type:"danger",msg:"Form is still invalid."}],void r.reject()):void a("users").actions.create(e.user,function(t,a){if(t){if(200!==t.status)if(e.alerts=[],a&&a.errors)for(var n in a.errors)"object"==typeof a.errors[n]&&e.alerts.push({type:"danger",msg:a.errors[n].message});else e.alerts=[{type:"danger",msg:"Server returned: "+t.status+" - "+t.code}];return void r.reject()}e.alerts=[{type:"success",msg:"Your account has been successfully created. Please check your E-Mails to complete the registration."}],e.signup_complete=!0,r.resolve()})}}]).controller("Users.Edit",["$scope","$q","apiService",function(e,t,a){var r=t.defer();e.alerts=[],e.user={name:null,email:null,avatar:null,password:null,password_confirm:null},e.closeAlert=function(t){e.alerts.splice(t,1)},e.submit=function(){var r=t.defer();return e.promiseString="Saving user...",e.promise=r.promise,e.$broadcast("show-errors-check-validity"),e.userForm.$invalid?(e.alerts=[{type:"danger",msg:"Form is still invalid."}],void r.reject()):(e.user.password&&0!==e.user.password.length&&e.user.password===e.user.password_confirm||(delete e.user.password,delete e.user.password_confirm),void a("users").actions.update("me",e.user,function(t){if(t){var a=[];if(409===t.status){var n=JSON.parse(t.message);for(var o in n)"object"==typeof n[o]&&a.push({type:"danger",msg:n[o].message})}else a=[{type:"danger",msg:"Server returned: "+t.status+" - "+t.code}];return e.alerts=a,void r.reject(t)}e.user.password=null,e.user.password_confirm=null,e.updateUser(),e.alerts=[{type:"success",msg:"Your account has been successfully updated."}],r.resolve()}))},e.promiseString="Loading user...",e.promise=r.promise,a("users").actions.find("me",function(t,a){t?(console.log("unable to get user",t),r.reject(t)):(e.user={name:a.name,email:a.email,avatar:a.avatar,password:null,password_confirm:null},r.resolve(a))})}]).controller("Users.Confirm",["$scope","$q","$location","$routeParams","apiService",function(e,t,a,r,n){var o=t.defer();e.promiseString="Confirming user...",e.promise=o.promise,n("users/me/access_tokens").actions.create({single_access_token:r.single_access_token},function(t,a){return t?(e.alerts=[{type:"danger",msg:"Your account could not be confirmed."}],void o.reject(t)):void n().getCredentials(a,function(t){return t?(e.alerts=[{type:"danger",msg:"Your account could not be confirmed."}],void o.reject(t)):(e.alerts=[{type:"success",msg:"Your account has been successfully confirmed."}],e.updateUser(),void o.resolve())})})}]).controller("Users.Login",["$scope","$q","$location","apiService",function(e,t,a,r){e.alerts=[],e.user={email:null,password:null},e.$parent.status="ready",e.closeAlert=function(t){e.alerts.splice(t,1)},e.submit=function(){var n=t.defer();e.promiseString="Logging in...",e.promise=n.promise,r().authenticate(e.user.email,e.user.password,function(t){return t?(e.alerts=[{type:"danger",msg:"Login failed."}],void n.reject(t)):(e.updateUser(),n.resolve(),void a.path("/"))})}}]).controller("Users.Logout",["$scope","authService",function(e,t){t.clearCredentials(),window.location="/"}])}();