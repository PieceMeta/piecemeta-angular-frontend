/**
 * piecemeta-angular-frontend - Angular-based web frontend for PieceMeta service
 * @version v0.9.2
 * @link http://www.piecemeta.com
 * @license MIT
 */
PIECEMETA_DEV_API_URL="https://api.piecemeta.com",PIECEMETA_API_HOST="https://api.piecemeta.com",function(){"use strict";angular.module("piecemeta-web.controllers.collections",["piecemeta-web.services.api"]).controller("Collections.Create",["$scope","apiService","$q","$location","$routeParams",function(e,a,t,r,n){e.dataCollection={title:null,description:null},e.formTitle="Create Collection",e.submit=function(){var n=t.defer();e.promiseString="Saving...",e.promise=n.promise,a("collections").actions.create(e.dataCollection,function(a,t){return a?(e.alerts=[{type:"danger",msg:"Failed to save Collection."}],void n.reject(a)):(e.alerts=[{type:"success",msg:"Successfully created Collection."}],n.resolve(),void r.path("/collections/"+t.uuid+"/edit"))})}}]).controller("Collections.Edit",["$scope","$routeParams","$q","apiService",function(e,a,t,r){var n=t.defer();e.promiseString="Loading Collection...",e.promise=n.promise,e.formTitle="Edit Collection",r("collections").actions.find(a.uuid,function(o,s){return o?(e.alerts=[{type:"danger",msg:"Failed to load Collection."}],n.reject(o),console.log("error getting collection",o)):(e.dataCollection=s,n.resolve(),void(e.submit=function(){var n=t.defer();e.promiseString="Saving...",e.promise=n.promise,r("collections").actions.update(a.uuid,e.dataCollection,function(a,t){return a?(console.log(a),e.alerts=[{type:"danger",msg:"Failed to update Collection."}],void n.reject(a)):(e.alerts=[{type:"success",msg:"Successfully updated Collection."}],void n.resolve())})}))})}])}(),function(){"use strict";angular.module("piecemeta-web.controllers.data-channels",["angularFileUpload","piecemeta-web.services.api"]).controller("DataChannels.Create",["$scope","apiService","$q","$location","$routeParams",function(e,a,t,r,n){var o=t.defer();e.data={dataChannel:{package_uuid:n.package_uuid}},e.formTitle="Create channel",e.promiseString="Loading...",e.promise=o.promise,async.waterfall([function(e){a("packages").actions.find(n.package_uuid,e)},function(a,t){return a?(e.data.dataPackage=a,void t(null)):void t(new Error("No package found."))}],function(s){return s?(e.alerts=[{type:"danger",msg:"Failed to load package."}],void o.reject(s)):(o.resolve(),void(e.submit=function(){var o=t.defer();e.promiseString="Saving...",e.promise=o.promise,a("channels").actions.create(e.data.dataChannel,function(a){return a?(e.alerts=[{type:"danger",msg:"Failed to save channel."}],void o.reject(a)):(e.alerts=[{type:"danger",msg:"Successfully saved channel."}],o.resolve(),void r.path("/packages/edit/"+n.package_uuid))})}))})}]).controller("DataChannels.Edit",["$scope","$routeParams","$q","$location","apiService",function(e,a,t,r,n){var o=t.defer();e.data={},e.promiseString="Loading channel...",e.promise=o.promise,e.formTitle="Edit channel",async.waterfall([function(e){n("channels").actions.find(a.uuid,e)},function(a,t){return a?(e.data.dataChannel=a,e.formTitle='Edit "'+a.title+'"',void t(null)):void t(new Error("No channel found."))},function(a){n("packages").actions.find(e.data.dataChannel.package_uuid,a)},function(a,t){return a?(e.data.dataPackage=a,void t(null)):void t(new Error("No package found."))},function(e){n("channels/"+a.uuid+"/streams").actions.all(e)},function(a,t){a.length>0&&(e.data.dataStreams=a.sort(function(e,a){return e.group<a.group?-1:e.group>a.group?1:0})),t(null)}],function(s){return s?(e.alerts=[{type:"danger",msg:"Failed to load channel."}],void o.reject(s)):(o.resolve(),e.$apply(),e.deleteStream=function(a,r){if(r.preventDefault(),window.confirm("Do you really want to delete this stream?")){var o=t.defer();e.promiseString="Deleting data stream...",e.promise=o.promise,e.data.dataStreams.splice(e.data.dataStreams.indexOf(a),1),n("streams").actions.remove(a.uuid,function(a){return a?(e.alerts=[{type:"danger",msg:"Failed to delete stream."}],o.reject(a),console.log("error deleting stream",a)):(e.alerts=[{type:"success",msg:"Successfully saved stream."}],o.resolve(),void e.$apply())})}},e.deleteCurrentItem=function(){if(window.confirm("Do you really want to delete this channel and all attached streams?")){var o=t.defer();e.promiseString="Deleting channel and streams...",e.promise=o.promise,async.waterfall([function(e){n("channels/"+a.uuid+"/streams").actions.all(function(a,t){async.each(t,function(e,a){n("streams").actions.remove(e.uuid,a)},e)})},function(e){n("channels").actions.remove(a.uuid,e)}],function(a){return a?(e.alerts=[{type:"danger",msg:"Failed to delete channel."}],o.reject(a),console.log("error deleting channel",a)):(o.resolve(),void r.path("/packages/"+e.data.dataPackage.uuid+"/edit"))})}},void(e.submit=function(){var r=t.defer();e.promiseString="Saving...",e.promise=r.promise,n("channels").actions.update(a.uuid,e.data.dataChannel,function(a,t){return a?(console.log(a),e.alerts=[{type:"danger",msg:"Failed to update channel."}],void r.reject(a)):(r.resolve(),void(e.alerts=[{type:"success",msg:"Successfully updated channel."}]))})}))})}])}(),function(){"use strict";angular.module("piecemeta-web.controllers.data-packages",["angularFileUpload","piecemeta-web.services.api","chartjs"]).controller("DataPackages.ImportBVH",["$scope","$q","authService","apiService",function(e,a,t,r){e.file=null,e.onFileSelect=function(t){var n=a.defer();e.promiseString="Importing data...",e.promise=n.promise,e.file=t[0],e.dataPackage=null,e.dataChannels=[];var o=new FileReader;o.onload=function(a){async.waterfall([function(e){e(null,BVH.parse(a.target.result))},function(a,t){e.motion=a,t(null)},function(e){var a={title:t[0].name};r("packages").actions.create(a,function(a,t){e(a,t)})},function(a,t){e.dataPackage=a,t(null)},function(a){async.eachSeries(e.motion.nodeList,function(a,t){var n={title:a.id,package_uuid:e.dataPackage.uuid};r("channels").create(n,function(n,o){if(n)return t(n);e.dataChannels.push(o);var s=[{title:"x",group:"position",value_offset:a.offsetX},{title:"y",group:"position",value_offset:a.offsetY},{title:"z",group:"position",value_offset:a.offsetZ},{title:"z",group:"rotation"},{title:"y",group:"rotation"},{title:"x",group:"rotation"}];for(var i in s)"object"==typeof s[i]&&(s[i].frames=[],s[i].fps=parseFloat((1/e.motion.frameTime).toFixed(2)));for(var l in a.frames)if("object"==typeof a.frames[l]){var c=a.frames[l];for(var u in c)"number"==typeof c[u]&&s[u].frames.push(c[u])}async.eachSeries(s,function(e,a){e.channel_uuid=o.uuid,r("streams").actions.create(e,function(e,t){a(e)})},function(e){t(e)})})},function(e){a(e)})},function(a){async.eachSeries(e.dataChannels,function(a,t){for(var n=0,o=e.motion.nodeList;o[n].id!==a.title&&n<o.length;)n+=1;if(o[n].parent){for(var s=0;e.dataChannels[s].title!==o[n].parent.id&&s<e.dataChannels.length;)s+=1;a.parent_channel_uuid=e.dataChannels[s].uuid,r("channels").actions.update(a.uuid,a,function(e){t(e)})}else t(null)},function(e){a(e)})}],function(e,a){return e?(console.log("error processing bvh file",e),void n.reject(e)):(console.log("successfully processed bvh file",a),void n.resolve())})},o.readAsText(t[0])}}]).controller("DataPackages.ImportOSC",["$scope","$q","authService","apiService","$routeParams",function(e,a,t,r,n){e.file=null,e.onFileSelect=function(t){var o=a.defer();e.promiseString="Importing data...",e.promise=o.promise,e.file=t[0],e.dataPackage=null,e.dataChannels=[];var s=new FileReader;s.onload=function(a){console.log("onload"),async.waterfall([function(e){var t;try{t=JSON.parse(a.target.result),e(null,t)}catch(r){e(new Error("error parsing json: "+r.toString()),null)}},function(e,a){if(n.garbage){var t=0,r={};for(var o in e)"object"==typeof e[o]&&e[o].length>0&&e[o].length>t&&(t=e[o].length);console.log("max frame is",t);for(var o in e)if("object"==typeof e[o]&&e[o].length>0&&(r[o]=[],e[o].length<t)){var s=t-e[o].length,i=Math.ceil(t/s),l=0;console.log("extend",e[o].length,s,i);for(var c=0;c<e[o].length;c+=1)e[o][c]&&(r[o].push(e[o][c]),s>l&&(r[o].push(e[o][c]),l+=1));for(;r[o].length<t;)r[o].push(e[o][e[o].length-1])}a(null,r)}else{var u=1e3/60,d={};for(var o in e)if("object"==typeof e[o]&&e[o].length>0){var p=1e3*e[o][0].m+e[o][0].s;d[o]=[],console.log("frames",e[o].length);for(var f in e[o]){for(var m=1e3*e[o][f].m+e[o][f].s,g=Math.round((m-p)/u),h=0;g>h;h+=1){var v=h*u,k=m+v;d[o].push({a:e[o][f].a,m:Math.floor(k/1e3),s:1e3*(k/1e3-Math.floor(k/1e3))})}p=m}}a(null,d)}},function(e,a){if(n.garbage){for(var t in e)"object"==typeof e[t]&&e[t].length>0&&console.log(t,e[t].length);a(null,e)}else{var r={},o=1e3/60;for(var t in e)if("object"==typeof e[t]&&e[t].length>0){var s=0,i=1e3*e[t][0].m+e[t][0].s;r[t]=[],console.log("frames",e[t].length);for(var l in e[t]){var c=1e3*e[t][l].m+e[t][l].s,u=Math.round((c-i)/o);1!==u?(s+=1,console.log("dropped faulty frame with diff != 1at",u,l)):r[t].push(e[t][l]),i=c}console.log("total faults",s)}a(null,r)}},function(e,a){if(n.garbage)a(null,e);else{var t=1e3/60;for(var r in e)if("object"==typeof e[r]&&e[r].length>0){var o=0,s=1e3*e[r][0].m+e[r][0].s;console.log("cleaned frames for index",r,e[r].length);for(var i in e[r]){var l=1e3*e[r][i].m+e[r][i].s,c=Math.round((l-s)/t);1!==c&&(o+=1),s=l}console.log("total faults",o)}a(null,e)}},function(e,a){var n={title:t[0].name};r("packages").actions.create(n,function(t,r){a(t,r,e)})},function(a,t,r){e.dataPackage=a,console.log(e.dataPackage),r(null,t)},function(a,t){for(var r in a)if("object"==typeof a[r]&&a[r].length>0){for(var n={title:r.substr(1,r.length-1),id:null,package_uuid:e.dataPackage.uuid,streams:[]},o=a[r][0].a.length,s=0;o>s;s+=1)n.streams.push({id:null,fps:60,channel_id:null,title:"p"+s.toString(),group:o>1?"grouped":null,frames:[]});for(var i in a[r])for(var l=0;o>l;l+=1)n.streams[l].frames.push(a[r][i].a[l]);e.dataChannels.push(n)}t(null)},function(a){async.eachSeries(e.dataChannels,function(a,t){a.package_uuid=e.dataPackage.uuid,r("channels").actions.create(a,function(n,o){return n?t(n):(e.dataChannels[e.dataChannels.indexOf(a)].uuid=o.uuid,void async.eachSeries(e.dataChannels[e.dataChannels.indexOf(a)].streams,function(e,a){e.channel_uuid=o.uuid,r("streams").actions.create(e,function(e,t){a(e)})},function(e){t(e)}))})},function(e){a(e)})}],function(e,a){return e?(console.log("error processing json file",e),void o.reject(e)):(console.log("successfully processed json file",a),void o.resolve())})},s.readAsText(t[0])}}]).controller("DataPackages.Show",["$scope","$q","$routeParams","apiService",function(e,a,t,r){e.data={dataChannels:[],streamGroups:[],dataPackage:null,currentGroup:null,channelIndex:0,chartSetup:{graphOptions:{showTooltips:!0,scaleShowLabels:!0,animation:!1,responsive:!0,pointDot:!1,bezierCurve:!1,scaleShowGridLines:!1,datasetFill:!1,legend:!0}},exports:{json:PIECEMETA_API_HOST+"/exports/"+t.uuid+".json",msgpack:PIECEMETA_API_HOST+"/exports/"+t.uuid+".msgpack",xml:PIECEMETA_API_HOST+"/exports/"+t.uuid+".xml"}},e.updateTimeout=null;var n=a.defer();e.promiseString="Loading data...",e.promise=n.promise,e.onURLClick=function(e){e.target.select()},e.updateChart=function(){var a={},t=0,r=null,n=["#ff0000","#732e00","#b2a159","#435946","#b6def2","#8660bf","#ff0088","#e50000","#331c0d","#d6e600","#40ffa6","#0066bf","#a38fbf","#4c0029","#d90000","#ffb380","#494d13","#269973","#80b3ff","#442d59","#99003d","#590000","#a67453","#818c69","#b6f2de","#434c59","#33004d","#bf6086","#d96c6c","#ffd9bf","#81f200","#005359","#334166","#a300cc","#d9003a","#332626","#cc8800","#448000","#36ced9","#263699","#fbbfff","#e6acbb","#7f2d20","#7f5500","#d6f2b6","#698a8c","#3d3df2","#cc33ad","#733941","#8c7369","#665533","#8fcc66","#002b40","#140099","#664d61","#ff6600","#ffcc00","#17330d","#308fbf","#120d33","#802060"];if(e.data.streamGroups=[],r=e.data.currentChannel){var o=Math.floor(8*Math.random());for(var s in r.streams)if(r.streams[s].frames.length>0){var i=[];if(r.streams[s].frames.length>1e3)for(var l=Math.floor(r.streams[s].frames.length/500),c=0;c<r.streams[s].frames.length;c+=l)i.push(r.streams[s].frames[c]);else i=r.streams[s].frames;if("object"==typeof r.streams[s]){for(var u=(r.streams[s].group?r.streams[s].group+"/":"")+r.streams[s].title,d=[],p=0;3>p;p+=1)d.push(Math.round(100*Math.random())+100);var f=n.splice(o,1),m={label:u,strokeColor:f,highlightStroke:f,pointColor:f,data:i};m.data.length>t&&(t=m.data.length),(!e.data.currentGroup||e.data.currentGroup&&e.data.currentGroup===r.streams[s].group)&&(a[u]=m),e.data.streamGroups.indexOf(r.streams[s].group)<0&&e.data.streamGroups.push(r.streams[s].group)}}else console.log("empty stream");var g=[],h=[];for(var v in a)"object"==typeof a[v]&&g.push(a[v]);for(var k=1;t>=k;k+=1)h.push("");e.data.streamGroups=e.data.streamGroups.sort(),e.data.currentGroup||(e.data.currentGroup=e.data.streamGroups[0]);var y={labels:h,datasets:g};e.data.chartSetup.graphDataSet=y}},async.waterfall([function(e){r("packages").actions.find(t.uuid,e)},function(e,a){r("users").actions.find(e.user_uuid,function(t,r){a(t,e,r)})},function(a,t,r){e.data.dataPackage=a,e.data.packageAuthor=t,e.data.dataURL=PIECEMETA_API_HOST+"/packages/"+a.uuid,r(null)},function(a){r("packages/"+e.data.dataPackage.uuid+"/channels").actions.all(a)},function(a,t){e.data.dataPackage.channels=a.sort(function(e,a){return e.title<a.title?-1:e.title>a.title?1:0}),t(null)},function(a){async.eachSeries(e.data.dataPackage.channels,function(a,t){r("channels/"+a.uuid+"/streams").actions.all(function(r,n){return r?t(r):(e.data.dataPackage.channels[e.data.dataPackage.channels.indexOf(a)].streams=n,void t())})},function(e){a(e)})},function(a){for(var t in e.data.dataPackage.channels)"object"==typeof e.data.dataPackage.channels[t]&&e.data.dataPackage.channels[t].streams.length>0&&e.data.dataChannels.push(e.data.dataPackage.channels[t]);a(null)},function(a){e.data.dataChannels.length>0&&(e.data.currentChannel=e.data.dataChannels[0]),a(null)},function(a){e.updateChart(),a(null)},function(a){e.$watch("data.currentChannel",function(a,t){e.data.currentGroup=null,e.updateChart()},!0),e.$watch("data.currentGroup",function(a,t){e.updateChart()},!0),a(null)}],function(a){return a?(n.reject(a),console.log("error getting data",t,a),void(e.$parent.status="ready")):(e.$apply(),n.resolve(),void(e.$parent.status="ready"))})}]).controller("DataPackages.List",["$scope","apiService",function(e,a){e.data={},a("packages").actions.all(function(a,t){return a?console.log("error getting packages",a):(e.data.data_packages=t.sort(function(e,a){return e.title<a.title?-1:e.title>a.title?1:0}),void e.$apply())})}]).controller("DataPackages.Create",["$scope","apiService","$q","$location",function(e,a,t,r){e.dataPackage={title:null,description:null,contributor_uuid:null},e.formTitle="Create package",e.submit=function(){var n=t.defer();e.promiseString="Saving...",e.promise=n.promise,a("packages").actions.create(e.dataPackage,function(a,t){return a?(e.alerts=[{type:"danger",msg:"Failed to save Package."}],void n.reject(a)):(e.alerts=[{type:"success",msg:"Successfully saved Package."}],n.resolve(),void r.path("/packages/"+t.uuid+"/edit"))})}}]).controller("DataPackages.Edit",["$scope","$routeParams","$q","$location","apiService",function(e,a,t,r,n){var o=t.defer();e.promiseString="Loading Package...",e.promise=o.promise,e.formTitle="Edit package",e.deleteChannel=function(a,r){if(r.preventDefault(),window.confirm("Do you really want to delete this channel and all attached streams?")){var o=t.defer();e.promiseString="Deleting channel and streams...",e.promise=o.promise,async.waterfall([function(e){n("channels/"+a.uuid+"/streams").actions.all(function(a,t){async.each(t,function(e,a){n("streams").actions.remove(e.uuid,a)},e)})},function(e){n("channels").actions.remove(a.uuid,e)}],function(t){return t?(e.alerts=[{type:"danger",msg:"Failed to delete channel."}],o.reject(t),console.log("error deleting channel",t)):(o.resolve(),e.dataChannels.splice(e.dataChannels.indexOf(a),1),void e.$apply())})}},e.deleteCurrentItem=function(){if(window.confirm("Do you really want to delete this package and all attached channels and streams?")){var o=t.defer();e.promiseString="Deleting package, channels and streams...",e.promise=o.promise,async.waterfall([function(e){n("packages/"+a.uuid+"/channels").actions.all(e)},function(e,a){async.each(e,function(e,a){n("channels/"+e.uuid+"/streams").actions.all(function(t,r){async.each(r,function(e,a){n("streams").actions.remove(e.uuid,a)},function(t){t?a(t):n("channels").actions.remove(e.uuid,a)})})},a)},function(e){n("packages").actions.remove(a.uuid,e)}],function(a){return a?(e.alerts=[{type:"danger",msg:"Failed to delete package."}],o.reject(a),console.log("error deleting package",a)):(o.resolve(),void r.path("/packages/browse"))})}},e.submit=function(){var r=t.defer();e.promiseString="Saving...",e.promise=r.promise,n("packages").actions.update(a.uuid,e.dataPackage,function(a,t){return a?(console.log(a),e.alerts=[{type:"danger",msg:"Failed to update Package."}],void r.reject(a)):(r.resolve(),void(e.alerts=[{type:"success",msg:"Successfully updated Package."}]))})},n("packages").actions.find(a.uuid,function(a,t){return a?(e.alerts=[{type:"danger",msg:"Failed to load Package."}],o.reject(a),console.log("error getting package",a)):(e.dataPackage=t,e.formTitle='Edit "'+t.title+'"',void n("packages/"+t.uuid+"/channels").actions.all(function(a,t){return a?(e.alerts=[{type:"danger",msg:"Failed to load Channels."}],o.reject(a),console.log("error getting channels",a)):(t.length>0&&(e.dataChannels=t.sort(function(e,a){return e.title<a.title?-1:e.title>a.title?1:0})),o.resolve(),void e.$apply())}))})}])}(),function(){"use strict";angular.module("piecemeta-web.controllers.data-streams",["angularFileUpload","piecemeta-web.services.api"]).controller("DataStreams.Create",["$scope","apiService","$q","$location","$routeParams",function(e,a,t,r,n){e.data={dataStream:{channel_uuid:n.uuid}};var o=t.defer();e.promiseString="Loading...",e.promise=o.promise,e.formTitle="Create stream",async.waterfall([function(e){a("channels").actions.find(n.uuid,e)},function(a,t){return a?(e.data.dataChannel=a,e.formTitle='Edit "'+a.title+'"',void t(null)):void t(new Error("No channel found."))},function(t){a("packages").actions.find(e.data.dataChannel.package_uuid,t)},function(a,t){return a?(e.data.dataPackage=a,void t(null)):void t(new Error("No package found."))}],function(n){return n?(e.alerts=[{type:"danger",msg:"Failed to load channel."}],void o.reject(n)):void(e.submit=function(){var n=t.defer();e.promiseString="Saving...",e.promise=n.promise,a("streams").actions.create(e.dataStream,function(a,t){return a?(e.alerts=[{type:"danger",msg:"Failed to save stream."}],void n.reject(a)):(e.alerts=[{type:"success",msg:"Successfully saved stream."}],n.resolve(),void r.path("/streams/"+t.uuid+"/edit"))})})})}]).controller("DataStreams.Edit",["$scope","$routeParams","$q","$location","apiService",function(e,a,t,r,n){var o=t.defer();e.data={},e.promiseString="Loading stream...",e.promise=o.promise,e.formTitle="Edit stream",async.waterfall([function(e){n("streams").actions.find(a.uuid,e)},function(a,t){return a?(e.data.dataStream=a,e.formTitle='Edit "'+a.title+'"',void t(null)):void t(new Error("No stream found."))},function(a){n("channels").actions.find(e.data.dataStream.channel_uuid,a)},function(a,t){return a?(e.data.dataChannel=a,void t(null)):void t(new Error("No channel found."))},function(a){n("packages").actions.find(e.data.dataChannel.package_uuid,a)},function(a,t){return a?(e.data.dataPackage=a,void t(null)):void t(new Error("No package found."))}],function(s){return s?(e.alerts=[{type:"danger",msg:"Failed to load stream."}],o.reject(s),console.log("error getting stream",s)):(o.resolve(),e.submit=function(){var r=t.defer();e.promiseString="Saving...",e.promise=r.promise,n("streams").actions.update(a.uuid,e.data.dataStream,function(a,t){return a?(console.log(a),e.alerts=[{type:"danger",msg:"Failed to update data stream."}],void r.reject(a)):(e.alerts=[{type:"success",msg:"Successfully updated stream."}],void r.resolve())})},e.deleteCurrentItem=function(){if(window.confirm("Do you really want to delete this stream?")){var o=t.defer();e.promiseString="Deleting data stream...",e.promise=o.promise,n("streams").actions.remove(a.uuid,function(a){return a?(e.alerts=[{type:"danger",msg:"Failed to delete stream."}],o.reject(a),console.log("error deleting stream",a)):(o.resolve(),void r.path("/channels/"+e.data.dataChannel.uuid+"/edit"))})}},void(e.onFileSelect=function(a){var t=new FileReader;t.onload=function(a){var t;try{t=JSON.parse(a.target.result)}catch(r){return console.log("error parsing json",r),void(e.alerts=[{type:"danger",msg:"Error parsing JSON"}])}"object"==typeof t&&t.length>0&&"number"==typeof t[0]?e.dataStream.data_frames=t:e.alerts=[{type:"danger",msg:"JSON is not in the required format"}]},t.readAsText(a[0])}))})}]).controller("DataStreams.ImportFile",["$scope","$q","apiService","$routeParams","$location",function(e,a,t,r,n){var o="",s=a.defer();e.data={dataPackage:null,selectedChannel:{},startFrame:1,regexString:"",regexPresets:[{title:"3 Numbers separated by space",data:"([-+]?[0-9]*\\.?[0-9]+) ([-+]?[0-9]*\\.?[0-9]+) ([-+]?[0-9]*\\.?[0-9]+)"},{title:"3 Numbers separated by semicolon",data:"([-+]?[0-9]*\\.?[0-9]+);([-+]?[0-9]*\\.?[0-9]+);([-+]?[0-9]*\\.?[0-9]+)"},{title:"2 Numbers separated by comma and enclosed in quotes",data:'"([-+]?[0-9]*\\.?[0-9]+)","([-+]?[0-9]*\\.?[0-9]+)"'}],channelTitle:"",resultLines:[],isComplete:!1},e.fileLines=[],e.frameCount=0,e.valLength=0,e.valLabel=[],e.promiseString="Loading...",e.promise=s.promise,async.waterfall([function(e){t("packages").actions.find(r.uuid,e)},function(a,t){a?(e.data.dataPackage=a,t(null)):t(new Error("package not found"))},function(e){t("packages/"+r.uuid+"/channels").actions.all(e)},function(a,t){a?(e.data.dataChannels=a,t(null)):t(new Error("no channels found"))}],function(e){return e?(console.log("error getting package",e),void s.reject(e)):void s.resolve()});var i=function(){if(e.regex){e.data.resultLines=[],e.valLength=0,e.valLabel=[];for(var a in e.fileLines){for(var t=null,r=[];null!==(t=e.regex.exec(e.fileLines[a]));)r=t;r.shift(),e.valLength<r.length&&(e.valLength=r.length),e.data.resultLines.push(r)}for(var n=0;n<e.valLength;n+=1)e.valLabel.push("")}};e.parseLines=function(){var a=o.split("\n");e.frameCount=a.length,e.fileLines=a.slice(Math.abs(parseInt(e.data.startFrame)),10),i()},e.updateRegex=function(a){a&&""!==a&&(e.regex=new RegExp(a,"gm"),i())},e.onFileSelect=function(t){var r=a.defer();e.promiseString="Reading file...",e.promise=r.promise;var n=new FileReader;n.onload=function(a){o=a.target.result,e.updateRegex(e.data.regexString),e.parseLines(),r.resolve()},n.readAsText(t[0])},e.submit=function(){var s=a.defer();if(e.promiseString="Adding channel...",e.promise=s.promise,e.$broadcast("show-errors-check-validity"),e.channelImportForm.$invalid)return e.alerts=[{type:"danger",msg:"You have to at least enter a title, frame rate and value titles."}],void s.reject();var i=[],l=o.split("\n");async.waterfall([function(a){for(var t=0;t<e.valLength;t+=1){var r={channel_uuid:e.data.selectedChannel.uuid,title:e.valLabel[t],fps:e.data.fps,group:e.data.valueGroup,frames:[]};i.push(r)}a(null)},function(a){for(var t in l){for(var r=null,n=[];null!==(r=e.regex.exec(l[t]));)n=r;n.shift();for(var o in n)"object"==typeof i[o]&&i[o].frames.push(n[o])}a(null)},function(a){if(e.data.selectedChannel.uuid)a(null,null);else{var n={package_uuid:r.uuid,title:e.data.selectedChannel.title?e.data.selectedChannel.title:e.data.channelTitle};t("channels").actions.create(n,a)}},function(a,t){t(null,e.data.selectedChannel.uuid||a.uuid)},function(e,a){async.eachSeries(i,function(a,r){a.channel_uuid=e,t("streams").actions.create(a,r)},function(e){a(e)})}],function(a){return a?(e.alerts=[{type:"danger",msg:"Failed to add streams"}],console.log("failed to create streams",a),void s.reject()):(e.alerts=[{type:"danger",msg:"Successfully added streams"}],n.path("/packages/"+r.uuid+"/edit"),void s.resolve())})}}]).controller("DataStreams.ImportTrac",["$scope","$q","apiService","$routeParams","$location",function(e,a,t,r,n){var o="",s=a.defer();e.data={dataPackage:null,dataChannels:null,dataStreams:[],selectedChannel:{},channelTitle:"",startFrame:1,fps:null,resultLines:[],isComplete:!1},e.fileLines=[],e.frameCount=0,e.valLength=0,e.valLabel=[],e.promiseString="Loading...",e.promise=s.promise,async.waterfall([function(e){t("packages").actions.find(r.uuid,e)},function(a,t){a?(e.data.dataPackage=a,t(null)):t(new Error("package not found"))},function(e){t("packages/"+r.uuid+"/channels").actions.all(e)},function(a,t){a?(e.data.dataChannels=a,t(null)):t(new Error("no channels found"))}],function(e){return e?(console.log("error getting package",e),void s.reject(e)):void s.resolve()}),e.parseLines=function(a){var t=Papa.parse(o).data,r=t.splice(0,5),n=r[3];n.splice(0,1);var s=r[4];for(s.splice(0,2);null===s[s.length-1]||""===s[s.length-1];)s.pop();var i=s.length+1;n=n.filter(function(e){return""!=e});var l=0;async.waterfall([function(a){e.data.fps=parseFloat(r[2][0]),e.frameCount=t.length,e.fileLines=t.slice(Math.abs(parseInt(e.data.startFrame)),10),a()},function(a){var t={channel_uuid:e.data.selectedChannel.uuid,title:n.shift(),frames:[],fps:e.data.fps};e.data.dataStreams.push(t),a()},function(a){async.eachSeries(n,function(a,t){var r=s.splice(0,3);async.each(r,function(t,r){var n={channel_uuid:e.data.selectedChannel.uuid,title:t.replace(/[0-9]/g,""),group:a,frames:[],fps:e.data.fps};e.data.dataStreams.push(n),r()},function(e){t(e)})},a)},function(a){for(var r in t){var n=t[r];n.splice(0,1),i!==n.length&&(l+=1);for(var o=0;i>o;o+=1)e.data.dataStreams[o].frames.push("undefined"==typeof n[o]?null:parseFloat(n[o]))}a()}],function(e){a(e,l)})},e.onFileSelect=function(t){var r=a.defer();e.promiseString="Reading file...",e.promise=r.promise;var n=new FileReader;n.onload=function(a){o=a.target.result,e.parseLines(function(a,t){t>0&&(e.alerts=[{type:"warning",msg:"The data contains "+t+" line(s) containing a different number of values than labels."}]),r.resolve(),e.$apply()})},n.readAsText(t[0])},e.submit=function(){var o=a.defer();return e.promiseString="Adding channel...",e.promise=o.promise,e.$broadcast("show-errors-check-validity"),e.tracImportForm.$invalid?(e.alerts=[{type:"danger",msg:"You have to at least enter a title, frame rate and value titles."}],void o.reject()):void async.waterfall([function(a){if(e.data.selectedChannel.uuid)a(null,null);else{var n={package_uuid:r.uuid,title:e.data.selectedChannel.title?e.data.selectedChannel.title:e.data.channelTitle};t("channels").actions.create(n,a)}},function(a,t){t(null,e.data.selectedChannel.uuid||a.uuid)},function(a,r){async.eachSeries(e.data.dataStreams,function(e,r){e.channel_uuid=a,t("streams").actions.create(e,r)},function(e){r(e)})}],function(a){return a?(e.alerts=[{type:"danger",msg:"Failed to add streams"}],console.log("failed to create streams",a),void o.reject()):(e.alerts=[{type:"danger",msg:"Successfully added streams"}],n.path("/packages/"+r.uuid+"/edit"),void o.resolve())})}}])}(),angular.module("piecemeta-web.directives.helpers",["piecemeta-web.services.api","piecemeta-web.services.auth"]).directive("checkLogin",["apiService","authService",function(e,a){"use strict";return{link:function(t){t.updateUser=function(){a.access_token&&e("users").actions.find("me",function(e,a){return e?(console.log("error fetching user",e),void(t.userSession=null)):(t.userSession=a,void t.$apply())})},t.updateUser()}}}]),angular.module("piecemeta-web.services.api",[]).factory("apiService",["authService",function(e){"use strict";return function(a,t){var r=PMApi({host:t?t:PIECEMETA_API_HOST,contentType:"application/json",api_key:e.api_key,access_token:e.access_token});return{client:r,actions:{all:function(e,t){r.resource(a).action("get",null,e,t)},find:function(e,t,n){r.resource(a).action("get",e,t,n)},create:function(e,t,n){r.resource(a).action("post",e,t,n)},update:function(e,t,n,o){t.uuid=e,r.resource(a).action("put",t,n,o)},remove:function(e,t,n){r.resource(a).action("delete",e,t,n)}},getCredentials:function(a,t){r.setToken(a),r.getCredentials(function(r,n){return r?t(r):void("object"==typeof n?(e.setCredentials(n,a),t(null)):t(new Error("Failed to get credentials")))})},authenticate:function(a,t,n){r.getToken({email:a,password:t},function(a,t){return a?n(a):void("object"==typeof t?r.getCredentials(function(a,r){return a?n(a):void("object"==typeof r?(e.setCredentials(r,t),n(null)):n(new Error("Failed to get credentials")))}):n(new Error("Failed to get token")))})}}}}]),function(){"use strict";angular.module("piecemeta-web.services.auth",[]).factory("authService",["$http",function(){var e={api_key:null,access_token:null,getCredentials:function(){e.api_key="string"==typeof localStorage.api_key?JSON.parse(localStorage.api_key):null,e.access_token="string"==typeof localStorage.access_token?JSON.parse(localStorage.access_token):null},setCredentials:function(a,t){localStorage.api_key=JSON.stringify(a),localStorage.access_token=JSON.stringify(t),e.getCredentials()},clearCredentials:function(){localStorage.removeItem("api_key"),localStorage.removeItem("access_token"),e.getCredentials()}};return e.getCredentials(),e}])}(),angular.module("piecemeta-web.services.spatial-viewer",[]).factory("spatialViewer",[function(){"use strict";var e={scene:new THREE.Scene,renderer:new THREE.CanvasRenderer,hierarchy:new THREE.Object3D,camera:null,meshes:{},dataSequence:null,frameIndex:0,frameCount:0,init:function(a,t,r){var n=document.querySelector(t).offsetWidth,o=document.querySelector(t).offsetHeight;0===o&&(o=320),e.dataPackage=a,e.camera=new THREE.PerspectiveCamera(75,n/o,1,1e4),e.camera.position.z=1e3,e.renderer.setSize(n,o);for(var s in a.data_channels)if("object"==typeof a.data_channels[s]){var i=new THREE.BoxGeometry(10,10,10),l=new THREE.MeshBasicMaterial({color:16711680,wireframe:!0}),c=new THREE.Mesh(i,l);e.meshes[a.data_channels[s].id]=c;for(var u in a.data_channels[s].data_streams)if("object"==typeof a.data_channels[s].data_streams[u]){var d=a.data_channels[s].data_streams[u];d.data_frames.length>e.frameCount&&(e.frameCount=d.data_frames.length),"number"==typeof d.data_frames[e.frameIndex]&&(e.meshes[a.data_channels[s].id][d.group][d.title]=10*(d.value_offset+d.data_frames[e.frameIndex]))}}for(var p in a.data_channels)if("object"==typeof a.data_channels[p]){var f=a.data_channels[p];f.parent_data_channel_id?e.meshes[f.parent_data_channel_id].add(e.meshes[f.id]):e.hierarchy.add(e.meshes[f.id])}e.scene.add(e.hierarchy),document.querySelector(t).appendChild(e.renderer.domElement),e.animate(),"function"==typeof r&&r()},animate:function(){window.requestAnimationFrame(e.animate),e.renderer.render(e.scene,e.camera)}};return e}]),function(){"use strict";angular.module("piecemeta-frontend",["ui.bootstrap","ngRoute","cgBusy","btford.markdown","piecemeta-web.controllers.site","piecemeta-web.controllers.users","piecemeta-web.controllers.collections","piecemeta-web.controllers.data-packages","piecemeta-web.controllers.data-channels","piecemeta-web.controllers.data-streams","piecemeta-web.controllers.trackers","piecemeta-web.directives.helpers"]).config(["$routeProvider","$locationProvider","$logProvider",function(e,a,t){t.debugEnabled(!0),a.html5Mode(!0).hashPrefix("!");var r="partials/";e.when("/",{templateUrl:r+"welcome.html",controller:"Site.Welcome"}),e.when("/about",{templateUrl:r+"about.html",controller:"Site.About"}),e.when("/software",{templateUrl:r+"software.html",controller:"Site.Software"}),e.when("/signup",{templateUrl:r+"signup.html",controller:"Users.Create"}),e.when("/me/account",{templateUrl:r+"account.html",controller:"Users.Edit"}),e.when("/confirm/:single_access_token",{templateUrl:r+"confirm",controller:"Users.Confirm"}),e.when("/login",{templateUrl:r+"login.html",controller:"Users.Login"}),e.when("/logout",{templateUrl:r+"logout.html",controller:"Users.Logout"}),e.when("/packages/browse",{templateUrl:r+"packages_browse.html",controller:"DataPackages.List"}),e.when("/packages/:uuid/channels/import/csv",{templateUrl:r+"streams_import.html",
controller:"DataStreams.ImportFile"}),e.when("/packages/:uuid/channels/import/trac",{templateUrl:r+"streams_import_trac.html",controller:"DataStreams.ImportTrac"}),e.when("/packages/upload",{templateUrl:r+"packages_upload.html",controller:"DataPackages.ImportBVH"}),e.when("/packages/uploadosc",{templateUrl:r+"packages_upload_osc.html",controller:"DataPackages.ImportOSC"}),e.when("/packages/create",{templateUrl:r+"packages_edit.html",controller:"DataPackages.Create"}),e.when("/packages/:uuid/edit",{templateUrl:r+"packages_edit.html",controller:"DataPackages.Edit"}),e.when("/packages/:uuid/show",{templateUrl:r+"packages_show.html",controller:"DataPackages.Show"}),e.when("/collections/create",{templateUrl:r+"collections_edit.html",controller:"Collections.Create"}),e.when("/collections/:uuid/edit",{templateUrl:r+"collections_edit.html",controller:"Collections.Edit"}),e.when("/channels/:uuid/streams/create",{templateUrl:r+"streams_edit.html",controller:"DataStreams.Create"}),e.when("/streams/:uuid/edit",{templateUrl:r+"streams_edit.html",controller:"DataStreams.Edit"}),e.when("/packages/:package_uuid/channels/create",{templateUrl:r+"channels_edit.html",controller:"DataChannels.Create"}),e.when("/channels/:uuid/edit",{templateUrl:r+"channels_edit.html",controller:"DataChannels.Edit"}),e.when("/trackers",{templateUrl:r+"trackers_list.html",controller:"Trackers.List"}),e.when("/trackers/create",{templateUrl:r+"trackers_edit.html",controller:"Trackers.Create"}),e.when("/trackers/:uuid/edit",{templateUrl:r+"trackers_edit.html",controller:"Trackers.Edit"}),e.otherwise({redirectTo:"/"})}]).run(["$rootScope","$q",function(e,a){Modernizr.localstorage&&Modernizr.canvas&&Modernizr.hashchange&&Modernizr.fontface||window.alert("Your browser is too old or not compatible with this website. It may still work, but most likely won't."),e.$on("$routeChangeStart",function(t,r,n){e.pageDefer=a.defer(),e.pagePromise=e.pageDefer.promise}),e.$on("$routeChangeSuccess",function(a,t,r){e.pageDefer.resolve()}),e.$on("$routeChangeError",function(a,t,r){e.pageDefer.reject()})}])}(),function(){"use strict";angular.module("piecemeta-web.controllers.site",[]).controller("Site.Welcome",["$scope",function(e){e.$parent.status="ready"}]).controller("Site.About",["$scope",function(e){e.$parent.status="ready"}]).controller("Site.Software",["$scope",function(e){e.$parent.status="ready"}])}(),function(){"use strict";angular.module("piecemeta-web.controllers.trackers",["piecemeta-web.services.api"]).controller("Trackers.Create",["$scope","apiService","$q","$location","$routeParams",function(e,a,t,r,n){e.tracker={title:null,description:null},e.formTitle="Create Tracker",e.submit=function(){var n=t.defer();e.promiseString="Saving...",e.promise=n.promise,a("trackers").actions.create(e.tracker,function(a,t){return a?(e.alerts=[{type:"danger",msg:"Failed to save tracker."}],void n.reject(a)):(e.alerts=[{type:"success",msg:"Successfully registered tracker."}],n.resolve(),void r.path("/trackers/"+t.id+"/edit"))})}}]).controller("Trackers.Edit",["$scope","$routeParams","$q","apiService",function(e,a,t,r){var n=t.defer();e.promiseString="Loading Tracker...",e.promise=n.promise,e.formTitle="Edit Tracker",r("trackers").actions.find(a.id,function(o,s){return o?(e.alerts=[{type:"danger",msg:"Failed to load tracker."}],n.reject(o),console.log("error getting tracker",o)):(e.tracker=s,n.resolve(),void(e.submit=function(){var n=t.defer();e.promiseString="Saving...",e.promise=n.promise,r("trackers").actions.update(a.id,e.tracker,function(a,t){return a?(console.log(a),e.alerts=[{type:"danger",msg:"Failed to update tracker."}],void n.reject(a)):(e.alerts=[{type:"success",msg:"Successfully updated tracker."}],void n.resolve())})}))})}]).controller("Trackers.List",["$scope","apiService",function(e,a){e.data={},a("trackers").actions.all(function(a,t){return a?console.log("error getting trackers",a):(e.data.trackers=t,void e.$apply())})}])}(),function(){"use strict";angular.module("piecemeta-web.controllers.users",["piecemeta-web.services.api","piecemeta-web.services.auth"]).controller("Users.Create",["$scope","$q","apiService",function(e,a,t){e.signup_complete=!1,e.alerts=[],e.user={name:null,email:null,password:null,password_confirm:null},e.closeAlert=function(a){e.alerts.splice(a,1)},e.$parent.status="ready",e.submit=function(){var r=a.defer();return e.promiseString="Registering...",e.promise=r.promise,e.$broadcast("show-errors-check-validity"),e.signupForm.$invalid?(e.alerts=[{type:"danger",msg:"Form is still invalid."}],void r.reject()):void t("users").actions.create(e.user,function(a,t){if(a){if(200!==a.status)if(e.alerts=[],t&&t.errors)for(var n in t.errors)"object"==typeof t.errors[n]&&e.alerts.push({type:"danger",msg:t.errors[n].message});else e.alerts=[{type:"danger",msg:"Server returned: "+a.status+" - "+a.code}];return void r.reject()}e.alerts=[{type:"success",msg:"Your account has been successfully created. Please check your E-Mails to complete the registration."}],e.signup_complete=!0,r.resolve()})}}]).controller("Users.Edit",["$scope","$q","apiService",function(e,a,t){var r=a.defer();e.alerts=[],e.user={name:null,email:null,avatar:null,password:null,password_confirm:null},e.closeAlert=function(a){e.alerts.splice(a,1)},e.submit=function(){var r=a.defer();return e.promiseString="Saving user...",e.promise=r.promise,e.$broadcast("show-errors-check-validity"),e.userForm.$invalid?(e.alerts=[{type:"danger",msg:"Form is still invalid."}],void r.reject()):(e.user.password&&0!==e.user.password.length&&e.user.password===e.user.password_confirm||(delete e.user.password,delete e.user.password_confirm),void t("users").actions.update("me",e.user,function(a){if(a){var t=[];if(409===a.status){var n=JSON.parse(a.message);for(var o in n)"object"==typeof n[o]&&t.push({type:"danger",msg:n[o].message})}else t=[{type:"danger",msg:"Server returned: "+a.status+" - "+a.code}];return e.alerts=t,void r.reject(a)}e.user.password=null,e.user.password_confirm=null,e.updateUser(),e.alerts=[{type:"success",msg:"Your account has been successfully updated."}],r.resolve()}))},e.promiseString="Loading user...",e.promise=r.promise,t("users").actions.find("me",function(a,t){a?(console.log("unable to get user",a),r.reject(a)):(e.user={name:t.name,email:t.email,avatar:t.avatar,password:null,password_confirm:null},r.resolve(t))})}]).controller("Users.Confirm",["$scope","$q","$location","$routeParams","apiService","authService",function(e,a,t,r,n,o){var s=a.defer();e.promiseString="Confirming user...",e.promise=s.promise,n("users/me/access_tokens").actions.create({single_access_token:r.single_access_token},function(a,t){return a?(e.alerts=[{type:"danger",msg:"Your account could not be confirmed."}],void s.reject(a)):void n().getCredentials(t,function(a){return a?(e.alerts=[{type:"danger",msg:"Your account could not be confirmed."}],void s.reject(a)):(e.alerts=[{type:"success",msg:"Your account has been successfully confirmed."}],e.updateUser(),void s.resolve())})})}]).controller("Users.Login",["$scope","$q","$location","apiService",function(e,a,t,r){e.alerts=[],e.user={email:null,password:null},e.$parent.status="ready",e.closeAlert=function(a){e.alerts.splice(a,1)},e.submit=function(){var n=a.defer();e.promiseString="Logging in...",e.promise=n.promise,r().authenticate(e.user.email,e.user.password,function(a){return a?(e.alerts=[{type:"danger",msg:"Login failed."}],void n.reject(a)):(e.updateUser(),n.resolve(),void t.path("/"))})}}]).controller("Users.Logout",["$scope","authService",function(e,a){a.clearCredentials(),window.location="/"}])}();